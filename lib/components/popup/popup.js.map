{"version":3,"file":"popup.js","sources":["../../../packages/components/popup/popup.tsx"],"sourcesContent":["import { useMouseUp, useResizeObserver } from \"@p/js/hooks\";\nimport { getPointPosition, getPosition } from \"@p/js/utils\";\nimport { useCreation, useReactive } from \"ahooks\";\nimport {\n\tCSSProperties,\n\tChildren,\n\tMouseEvent,\n\tcloneElement,\n\tisValidElement,\n\tuseEffect,\n\tuseLayoutEffect,\n\tuseMemo,\n\tuseRef,\n} from \"react\";\nimport Content from \"./content\";\nimport \"./index.css\";\nimport { IPopup } from \"./type\";\n\nexport default function Popup(props: IPopup) {\n\tconst {\n\t\tvisible = false,\n\t\tcontent,\n\t\ttrigger = \"hover\",\n\t\tgap = 12,\n\t\toffset = 8,\n\t\tfixed,\n\t\tposition = \"top\",\n\t\tshowDelay = 16,\n\t\thideDelay = 12,\n\t\ttouchable,\n\t\tarrow = true,\n\t\talign,\n\t\tfitSize,\n\t\twatchResize,\n\t\tclickOutside = true,\n\t\tdisabled,\n\t\treferToWindow,\n\t\tstyle,\n\t\tclassName,\n\t\tgetContainer,\n\t\tchildren,\n\t\tonVisibleChange,\n\t} = props;\n\n\tconst triggerRef = useRef<HTMLElement>(null);\n\tconst contentRef = useRef<HTMLDivElement>(null);\n\tconst timerRef = useRef<any>(null);\n\tconst statusRef = useRef<string>(\"\");\n\tconst state = useReactive<{\n\t\tshow: boolean;\n\t\tstyle: CSSProperties;\n\t\tarrowProps: Record<string, any>;\n\t}>({\n\t\tshow: false,\n\t\tstyle: { position: fixed ? \"fixed\" : \"absolute\" },\n\t\tarrowProps: {},\n\t});\n\n\tuseMouseUp((e) => {\n\t\tif (!triggerRef.current || !contentRef.current || !clickOutside) return;\n\n\t\tconst tar = e.target as HTMLElement;\n\t\tconst isContain =\n\t\t\ttriggerRef.current.contains(tar) ||\n\t\t\tcontentRef.current.contains(tar);\n\n\t\tif (!state.show || isContain) return;\n\n\t\thandleToggle(false);\n\t});\n\n\tconst clearTimer = () => {\n\t\tif (!timerRef.current) return;\n\t\tclearTimeout(timerRef.current);\n\t\ttimerRef.current = null;\n\t};\n\n\tconst handleShow = () => {\n\t\tif (disabled) return;\n\t\tif (\n\t\t\tstate.show &&\n\t\t\t(trigger !== \"hover\" || (trigger === \"hover\" && !touchable))\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tstate.show = true;\n\t\tstatusRef.current = \"showing\";\n\t\ttimerRef.current = setTimeout(() => {\n\t\t\tif (statusRef.current !== \"showing\") {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst [left, top, { arrowX, arrowY, arrowPos }] = getPosition(\n\t\t\t\ttriggerRef.current,\n\t\t\t\tcontentRef.current,\n\t\t\t\t{\n\t\t\t\t\tposition,\n\t\t\t\t\tgap,\n\t\t\t\t\toffset,\n\t\t\t\t\talign,\n\t\t\t\t\trefWindow: referToWindow,\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tstate.style = {\n\t\t\t\t...state.style,\n\t\t\t\topacity: 1,\n\t\t\t\ttransform: \"none\",\n\t\t\t\tleft,\n\t\t\t\ttop,\n\t\t\t};\n\t\t\tstate.arrowProps = {\n\t\t\t\tleft: arrowX,\n\t\t\t\ttop: arrowY,\n\t\t\t\tpos: arrowPos,\n\t\t\t};\n\t\t\tonVisibleChange?.(true);\n\t\t\tclearTimer();\n\t\t\tstatusRef.current = \"\";\n\t\t}, showDelay);\n\t};\n\n\tconst handleHide = () => {\n\t\tif (!state.show) return;\n\n\t\tstatusRef.current = \"hiding\";\n\t\ttimerRef.current = setTimeout(() => {\n\t\t\tif (statusRef.current !== \"hiding\") {\n\t\t\t\tclearTimer();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstate.style = {\n\t\t\t\t...state.style,\n\t\t\t\topacity: 0,\n\t\t\t\ttransform: \"translate(0, 2px)\",\n\t\t\t};\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tstate.show = false;\n\t\t\t\tclearTimer();\n\t\t\t\tonVisibleChange?.(false);\n\t\t\t\tstatusRef.current = \"\";\n\t\t\t}, 160);\n\t\t}, hideDelay);\n\t};\n\n\tconst handleToggle = (action?: boolean) => {\n\t\tif (action !== undefined) {\n\t\t\taction ? handleShow() : handleHide();\n\t\t\treturn;\n\t\t}\n\n\t\tstate.show ? handleHide() : handleShow();\n\t};\n\tconst eventMaps = useCreation(\n\t\t() => ({\n\t\t\tclick: {\n\t\t\t\tonClick: () => handleToggle(true),\n\t\t\t},\n\t\t\thover: {\n\t\t\t\tonMouseEnter: () => handleToggle(true),\n\t\t\t\tonMouseLeave: () => handleToggle(false),\n\t\t\t},\n\t\t\tfocus: {\n\t\t\t\tonFocus: () => handleToggle(true),\n\t\t\t\tonBlur: () => handleToggle(false),\n\t\t\t},\n\t\t\tcontextmenu: {\n\t\t\t\tonContextMenu: (e: MouseEvent) => {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tif (state.show) {\n\t\t\t\t\t\tconst [left, top] = getPointPosition(\n\t\t\t\t\t\t\te,\n\t\t\t\t\t\t\tcontentRef.current as HTMLElement\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstate.style = {\n\t\t\t\t\t\t\t...state.style,\n\t\t\t\t\t\t\tleft,\n\t\t\t\t\t\t\ttop,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tstate.show = true;\n\n\t\t\t\t\ttimerRef.current = setTimeout(() => {\n\t\t\t\t\t\tconst [left, top] = getPointPosition(\n\t\t\t\t\t\t\te,\n\t\t\t\t\t\t\tcontentRef.current as HTMLElement\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstate.style = {\n\t\t\t\t\t\t\t...state.style,\n\t\t\t\t\t\t\topacity: 1,\n\t\t\t\t\t\t\ttransform: \"none\",\n\t\t\t\t\t\t\tleft,\n\t\t\t\t\t\t\ttop,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tclearTimer();\n\t\t\t\t\t\tonVisibleChange?.(true);\n\t\t\t\t\t}, showDelay);\n\t\t\t\t},\n\t\t\t},\n\t\t\tnone: {},\n\t\t}),\n\t\t[]\n\t);\n\n\tconst contentTouch = useMemo(() => {\n\t\tif (!touchable) return {};\n\t\tconst events: { [key: string]: () => void } = {};\n\n\t\tif (trigger === \"hover\") {\n\t\t\tevents[\"onMouseEnter\"] = () => {\n\t\t\t\tclearTimer();\n\t\t\t};\n\t\t\tevents[\"onMouseLeave\"] = () => handleToggle(false);\n\t\t}\n\n\t\treturn events;\n\t}, [touchable, trigger]);\n\n\tconst computePosition = () => {\n\t\tif (!state.show) return;\n\n\t\tconst [left, top, { arrowX, arrowY, arrowPos }] = getPosition(\n\t\t\ttriggerRef.current,\n\t\t\tcontentRef.current,\n\t\t\t{\n\t\t\t\tposition,\n\t\t\t\tgap,\n\t\t\t\toffset,\n\t\t\t\talign,\n\t\t\t\trefWindow: referToWindow,\n\t\t\t}\n\t\t);\n\n\t\tObject.assign(state, {\n\t\t\tstyle: { ...state.style, left, top },\n\t\t\tarrowProps: { left: arrowX, top: arrowY, pos: arrowPos },\n\t\t});\n\t};\n\n\tuseEffect(() => {\n\t\tif (trigger === \"contextmenu\") return;\n\t\tconst { observe, unobserve, disconnect } = useResizeObserver();\n\n\t\ttriggerRef.current && observe(triggerRef.current, computePosition);\n\n\t\tif (!watchResize || !contentRef.current) return;\n\n\t\tobserve(contentRef.current, computePosition);\n\n\t\treturn () => {\n\t\t\tif (!watchResize || !contentRef.current) return;\n\n\t\t\tunobserve(contentRef.current);\n\t\t\ttriggerRef.current && unobserve(triggerRef.current);\n\t\t\tdisconnect();\n\t\t};\n\t}, [watchResize, contentRef.current, triggerRef.current]);\n\n\tuseLayoutEffect(() => {\n\t\tif (!fitSize || !state.show) return;\n\n\t\tconst vertical = [\"top\", \"bottom\"].includes(position);\n\t\tconst size =\n\t\t\ttriggerRef.current?.[vertical ? \"offsetWidth\" : \"offsetHeight\"];\n\t\tstate.style = { ...state.style, [vertical ? \"width\" : \"height\"]: size };\n\t}, [state.show, fitSize]);\n\n\tuseLayoutEffect(() => {\n\t\thandleToggle(visible);\n\t}, [visible]);\n\n\treturn (\n\t\t<>\n\t\t\t{Children.map(children, (child) => {\n\t\t\t\tif (!isValidElement(child)) return;\n\n\t\t\t\tconst { className, ...restProps } = child.props as any;\n\t\t\t\tObject.keys(eventMaps[trigger]).map((evt) => {\n\t\t\t\t\tif (!restProps[evt]) return;\n\t\t\t\t\tconst fn = eventMaps[trigger][evt];\n\n\t\t\t\t\teventMaps[trigger][evt] = (e) => {\n\t\t\t\t\t\tfn();\n\t\t\t\t\t\trestProps[evt](e);\n\t\t\t\t\t};\n\t\t\t\t});\n\n\t\t\t\treturn cloneElement(child, {\n\t\t\t\t\tref: triggerRef,\n\t\t\t\t\tclassName,\n\t\t\t\t\t...restProps,\n\t\t\t\t\t...eventMaps[trigger],\n\t\t\t\t});\n\t\t\t})}\n\n\t\t\t{state.show && (\n\t\t\t\t<Content\n\t\t\t\t\tref={contentRef}\n\t\t\t\t\tarrow={arrow && trigger !== \"contextmenu\"}\n\t\t\t\t\tstyle={{ ...style, ...state.style }}\n\t\t\t\t\tarrowProps={state.arrowProps}\n\t\t\t\t\tclassName={className}\n\t\t\t\t\t{...contentTouch}\n\t\t\t\t\ttrigger={triggerRef.current as HTMLElement}\n\t\t\t\t\tgetContainer={getContainer}\n\t\t\t\t>\n\t\t\t\t\t{content}\n\t\t\t\t</Content>\n\t\t\t)}\n\t\t</>\n\t);\n}\n"],"names":["Popup","props","visible","content","trigger","gap","offset","fixed","position","showDelay","hideDelay","touchable","arrow","align","fitSize","watchResize","clickOutside","disabled","referToWindow","style","className","getContainer","children","onVisibleChange","triggerRef","useRef","contentRef","timerRef","statusRef","state","useReactive","show","arrowProps","useMouseUp","e","current","tar","target","isContain","contains","handleToggle","clearTimer","clearTimeout","handleShow","setTimeout","left","top","arrowX","arrowY","arrowPos","getPosition","refWindow","opacity","transform","pos","handleHide","action","undefined","eventMaps","useCreation","click","onClick","hover","onMouseEnter","onMouseLeave","focus","onFocus","onBlur","contextmenu","onContextMenu","preventDefault","stopPropagation","getPointPosition","none","contentTouch","useMemo","events","computePosition","Object","assign","useEffect","observe","unobserve","disconnect","useResizeObserver","useLayoutEffect","vertical","includes","size","_jsxs","_Fragment","Children","map","child","isValidElement","restProps","keys","evt","fn","cloneElement","ref","_jsx","Content"],"mappings":"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"}
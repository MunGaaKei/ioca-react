{"version":3,"file":"useForm.js","sources":["../../../packages/components/form/useForm.ts"],"sourcesContent":["import PubSub from \"pubsub-js\";\nimport { uid } from \"radash\";\nimport { useRef } from \"react\";\nimport { IForm, TRule } from \"./type\";\n\nexport class IFormInstance {\n\treadonly id?: string;\n\tdata: Record<string, any> = {};\n\tcacheData: Record<string, any> = {};\n\trules?: Pick<IForm, \"rules\"> = {};\n\n\tconstructor() {\n\t\tthis.id = uid(8);\n\t\tthis.data = {};\n\t}\n\n\tget(field?: string) {\n\t\treturn field ? this.data[field] : this.data;\n\t}\n\n\tset(field: any, value?: any) {\n\t\tconst id = this.id;\n\t\tif (!this.data) return;\n\n\t\tif (typeof field === \"string\") {\n\t\t\tthis.data[field] = value;\n\t\t\tthis.cacheData[field] = value;\n\t\t\tPubSub.publish(`${id}:set:${field}`, value);\n\t\t\treturn;\n\t\t}\n\n\t\tObject.keys(field).map((name) => {\n\t\t\tthis.data[name] = field[name];\n\t\t\tthis.cacheData[name] = field[name];\n\t\t\tPubSub.publish(`${id}:set:${name}`, field[name]);\n\t\t});\n\t}\n\n\tdelete(field) {\n\t\tdelete this.data[field];\n\t}\n\n\tclear() {\n\t\tif (!this.data) return;\n\t\tthis.cacheData = {};\n\n\t\tObject.keys(this.data).map((name) => {\n\t\t\tPubSub.publish(`${this.id}:set:${name}`, undefined);\n\t\t\tthis.data[name] = undefined;\n\t\t});\n\t}\n\n\tasync validate(field?: string) {\n\t\tconst { id, rules, data } = this;\n\t\tif (!rules) return data;\n\n\t\tif (field) {\n\t\t\tconst o = rules[field];\n\t\t\tconst rule: TRule = {\n\t\t\t\tvalidator: (v) =>\n\t\t\t\t\tArray.isArray(v)\n\t\t\t\t\t\t? v.length > 0\n\t\t\t\t\t\t: ![undefined, null, \"\"].includes(v),\n\t\t\t\tmessage: undefined,\n\t\t\t};\n\n\t\t\tif (typeof o === \"function\") {\n\t\t\t\trule.validator = o;\n\t\t\t} else if (o === true) {\n\t\t\t\trule.message = \"required\";\n\t\t\t} else {\n\t\t\t\tObject.assign(rule, o);\n\t\t\t}\n\n\t\t\tconst isValid = rule.validator?.(data[field], this);\n\n\t\t\tif (!isValid) {\n\t\t\t\tPubSub.publish(`${id}:invalid:${field}`, {\n\t\t\t\t\tmessage: rule.message,\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t});\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tPubSub.publish(`${id}:invalid:${name}`, {\n\t\t\t\tmessage: null,\n\t\t\t\tstatus: \"normal\",\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\n\t\tlet isAllValid = true;\n\n\t\tObject.keys(data).map((name) => {\n\t\t\tconst o = rules[name];\n\t\t\tif (o === undefined) return;\n\n\t\t\tconst rule: TRule = {\n\t\t\t\tvalidator: (v) => (Array.isArray(v) ? v.length > 0 : !!v),\n\t\t\t\tmessage: undefined,\n\t\t\t};\n\n\t\t\tif (typeof o === \"function\") {\n\t\t\t\trule.validator = o;\n\t\t\t} else if (o === true) {\n\t\t\t\trule.message = \"required\";\n\t\t\t} else {\n\t\t\t\tObject.assign(rule, o);\n\t\t\t}\n\n\t\t\tconst isValid = rule.validator?.(data[name], this);\n\n\t\t\tif (!isValid) {\n\t\t\t\tPubSub.publish(`${id}:invalid:${name}`, {\n\t\t\t\t\tmessage: rule.message,\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t});\n\t\t\t\tisAllValid = false;\n\t\t\t} else {\n\t\t\t\tPubSub.publish(`${id}:invalid:${name}`, {\n\t\t\t\t\tmessage: null,\n\t\t\t\t\tstatus: \"normal\",\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\treturn isAllValid ? Promise.resolve(data) : false;\n\t}\n}\n\nexport default function useForm(form?: IFormInstance) {\n\tconst formRef = useRef<IFormInstance>(null);\n\n\tif (!formRef.current) {\n\t\tformRef.current = form ?? new IFormInstance();\n\t}\n\n\treturn formRef.current;\n}\n"],"names":["IFormInstance","id","data","cacheData","rules","constructor","this","uid","get","field","set","value","PubSub","publish","Object","keys","map","name","clear","undefined","validate","o","rule","validator","v","Array","isArray","length","includes","message","assign","isValid","status","isAllValid","Promise","resolve","useForm","form","formRef","useRef","current"],"mappings":"2FAKaA,EACHC,GACTC,KAA4B,CAAE,EAC9BC,UAAiC,CAAE,EACnCC,MAA+B,CAAE,EAEjC,WAAAC,GACCC,KAAKL,GAAKM,EAAI,GACdD,KAAKJ,KAAO,CAAE,EAGf,GAAAM,CAAIC,GACH,OAAOA,EAAQH,KAAKJ,KAAKO,GAASH,KAAKJ,KAGxC,GAAAQ,CAAID,EAAYE,GACf,MAAMV,EAAKK,KAAKL,GAChB,GAAKK,KAAKJ,KAEV,MAAqB,iBAAVO,GACVH,KAAKJ,KAAKO,GAASE,EACnBL,KAAKH,UAAUM,GAASE,OACxBC,EAAOC,QAAQ,GAAGZ,SAAUQ,IAASE,SAItCG,OAAOC,KAAKN,GAAOO,KAAKC,IACvBX,KAAKJ,KAAKe,GAAQR,EAAMQ,GACxBX,KAAKH,UAAUc,GAAQR,EAAMQ,GAC7BL,EAAOC,QAAQ,GAAGZ,SAAUgB,IAAQR,EAAMQ,GAAM,IAIlD,OAAOR,UACCH,KAAKJ,KAAKO,GAGlB,KAAAS,GACMZ,KAAKJ,OACVI,KAAKH,UAAY,CAAE,EAEnBW,OAAOC,KAAKT,KAAKJ,MAAMc,KAAKC,IAC3BL,EAAOC,QAAQ,GAAGP,KAAKL,UAAUgB,SAAQE,GACzCb,KAAKJ,KAAKe,QAAQE,CAAS,KAI7B,cAAMC,CAASX,GACd,MAAMR,GAAEA,EAAEG,MAAEA,EAAKF,KAAEA,GAASI,KAC5B,IAAKF,EAAO,OAAOF,EAEnB,GAAIO,EAAO,CACV,MAAMY,EAAIjB,EAAMK,GACVa,EAAc,CACnBC,UAAYC,GACXC,MAAMC,QAAQF,GACXA,EAAEG,OAAS,GACV,MAACR,EAAW,KAAM,IAAIS,SAASJ,GACpCK,aAASV,GAGO,mBAANE,EACVC,EAAKC,UAAYF,GACD,IAANA,EACVC,EAAKO,QAAU,WAEff,OAAOgB,OAAOR,EAAMD,GAGrB,MAAMU,EAAUT,EAAKC,YAAYrB,EAAKO,GAAQH,MAE9C,OAAKyB,GAQLnB,EAAOC,QAAQ,GAAGZ,aAAcgB,OAAQ,CACvCY,QAAS,KACTG,OAAQ,YAEF,IAXNpB,EAAOC,QAAQ,GAAGZ,aAAcQ,IAAS,CACxCoB,QAASP,EAAKO,QACdG,OAAQ,WAEF,GAUT,IAAIC,GAAa,EAmCjB,OAjCAnB,OAAOC,KAAKb,GAAMc,KAAKC,IACtB,MAAMI,EAAIjB,EAAMa,GAChB,QAAUE,IAANE,EAAiB,OAErB,MAAMC,EAAc,CACnBC,UAAYC,GAAOC,MAAMC,QAAQF,GAAKA,EAAEG,OAAS,IAAMH,EACvDK,aAASV,GAGO,mBAANE,EACVC,EAAKC,UAAYF,GACD,IAANA,EACVC,EAAKO,QAAU,WAEff,OAAOgB,OAAOR,EAAMD,GAGrB,MAAMU,EAAUT,EAAKC,YAAYrB,EAAKe,GAAOX,MAExCyB,EAOJnB,EAAOC,QAAQ,GAAGZ,aAAcgB,IAAQ,CACvCY,QAAS,KACTG,OAAQ,YARTpB,EAAOC,QAAQ,GAAGZ,aAAcgB,IAAQ,CACvCY,QAASP,EAAKO,QACdG,OAAQ,UAETC,GAAa,QASRA,GAAaC,QAAQC,QAAQjC,IAId,SAAAkC,EAAQC,GAC/B,MAAMC,EAAUC,EAAsB,MAMtC,OAJKD,EAAQE,UACZF,EAAQE,QAAUH,GAAQ,IAAIrC,GAGxBsC,EAAQE,OAChB"}
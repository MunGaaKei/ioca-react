{"version":3,"file":"field.js","sources":["../../../packages/components/form/field.tsx"],"sourcesContent":["import { useReactive } from \"ahooks\";\nimport PubSub from \"pubsub-js\";\nimport {\n\tChildren,\n\tcloneElement,\n\tisValidElement,\n\tuseContext,\n\tuseEffect,\n\tuseMemo,\n} from \"react\";\nimport Context from \"./context\";\nimport { IField } from \"./type\";\n\nfunction Field(props: IField) {\n\tconst { name, required, children } = props;\n\tconst state = useReactive({\n\t\tvalue: undefined,\n\t\tstatus: \"normal\",\n\t\tmessage: undefined,\n\t\tupdate: 0,\n\t});\n\tconst form = useContext(Context);\n\tconst { id } = form;\n\n\tconst handleChange = (v) => {\n\t\tif (!name) return;\n\n\t\tform.set(name, v);\n\t\tPubSub.publish(`${id}:change`, {\n\t\t\tname,\n\t\t\tvalue: v,\n\t\t});\n\t};\n\n\tconst hijackChildren = useMemo(() => {\n\t\treturn Children.map(children, (node) => {\n\t\t\tif (!isValidElement(node)) return null;\n\n\t\t\tconst { onChange } = node.props as any;\n\t\t\tconst { value, status, message } = state;\n\n\t\t\treturn cloneElement(node, {\n\t\t\t\tvalue,\n\t\t\t\tstatus,\n\t\t\t\tmessage,\n\t\t\t\trequired,\n\t\t\t\tonChange: (...args) => {\n\t\t\t\t\thandleChange(args[0]);\n\t\t\t\t\tonChange?.(...args);\n\t\t\t\t\tObject.assign(state, {\n\t\t\t\t\t\tstatus: \"normal\",\n\t\t\t\t\t\tmessage: undefined,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t} as any);\n\t\t});\n\t}, [children, state.update]);\n\n\tuseEffect(() => {\n\t\tif (!name) return;\n\n\t\tPubSub.subscribe(`${id}:set:${name}`, (evt, v) => {\n\t\t\tstate.value = v;\n\t\t\tstate.update += 1;\n\t\t});\n\t\tPubSub.subscribe(`${id}:invalid:${name}`, (evt, v) => {\n\t\t\tObject.assign(state, v);\n\t\t\tstate.update += 1;\n\t\t});\n\n\t\tPromise.resolve().then(() => {\n\t\t\tform.set(name, form.cacheData[name] ?? undefined);\n\t\t});\n\n\t\treturn () => {\n\t\t\tPubSub.unsubscribe(`${id}:set:${name}`);\n\t\t\tPubSub.unsubscribe(`${id}:invalid:${name}`);\n\t\t\tform.delete(name);\n\t\t};\n\t}, [name, children]);\n\n\tif (!name) return children;\n\n\treturn hijackChildren;\n}\n\nexport default Field;\n"],"names":["Field","props","name","required","children","state","useReactive","value","undefined","status","message","update","form","useContext","Context","id","hijackChildren","useMemo","Children","map","node","isValidElement","onChange","cloneElement","args","v","set","PubSub","publish","Object","assign","useEffect","subscribe","evt","Promise","resolve","then","cacheData","unsubscribe","delete"],"mappings":"6MAaA,SAASA,EAAMC,GACd,MAAMC,KAAEA,EAAIC,SAAEA,EAAQC,SAAEA,GAAaH,EAC/BI,EAAQC,EAAY,CACzBC,WAAOC,EACPC,OAAQ,SACRC,aAASF,EACTG,OAAQ,IAEHC,EAAOC,EAAWC,IAClBC,GAAEA,GAAOH,EAYTI,EAAiBC,GAAQ,IACvBC,EAASC,IAAIf,GAAWgB,IAC9B,IAAKC,EAAeD,GAAO,OAAO,KAElC,MAAME,SAAEA,GAAaF,EAAKnB,OACpBM,MAAEA,EAAKE,OAAEA,EAAMC,QAAEA,GAAYL,EAEnC,OAAOkB,EAAaH,EAAM,CACzBb,QACAE,SACAC,UACAP,WACAmB,SAAU,IAAIE,KAtBI,IAACC,IAuBLD,EAAK,GAtBhBtB,IAELU,EAAKc,IAAIxB,EAAMuB,GACfE,EAAOC,QAAQ,GAAGb,WAAa,CAC9Bb,OACAK,MAAOkB,KAkBLH,OAAcE,GACdK,OAAOC,OAAOzB,EAAO,CACpBI,OAAQ,SACRC,aAASF,GACR,GAEK,KAER,CAACJ,EAAUC,EAAMM,SAyBpB,OAvBAoB,GAAU,KACT,GAAK7B,EAeL,OAbAyB,EAAOK,UAAU,GAAGjB,SAAUb,KAAQ,CAAC+B,EAAKR,KAC3CpB,EAAME,MAAQkB,EACdpB,EAAMM,QAAU,CAAC,IAElBgB,EAAOK,UAAU,GAAGjB,aAAcb,KAAQ,CAAC+B,EAAKR,KAC/CI,OAAOC,OAAOzB,EAAOoB,GACrBpB,EAAMM,QAAU,CAAC,IAGlBuB,QAAQC,UAAUC,MAAK,KACtBxB,EAAKc,IAAIxB,EAAMU,EAAKyB,UAAUnC,SAASM,EAAU,IAG3C,KACNmB,EAAOW,YAAY,GAAGvB,SAAUb,KAChCyB,EAAOW,YAAY,GAAGvB,aAAcb,KACpCU,EAAK2B,OAAOrC,EAAK,CACjB,GACC,CAACA,EAAME,IAELF,EAEEc,EAFWZ,CAGnB"}
{"version":3,"file":"datagrid.js","sources":["../../../packages/components/datagrid/datagrid.tsx"],"sourcesContent":["import { getNextSorter } from \"@p/js/utils\";\nimport { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { CSSProperties, MouseEvent, useEffect, useMemo, useRef } from \"react\";\nimport ScrollContainer, { Scrollbars } from \"react-custom-scrollbars-2\";\nimport Loading from \"../loading\";\nimport Empty from \"../utils/empty\";\nimport \"./index.css\";\nimport Row, { Header } from \"./row\";\nimport type { IColumn, IData, IDatagrid, TDatagridState } from \"./type\";\n\nconst Datagrid = (props: IDatagrid) => {\n\tconst {\n\t\tdata = [],\n\t\tcolumns = [],\n\t\tborder,\n\t\tstriped,\n\t\theader = true,\n\t\tresizable,\n\t\tcellPadding = \".5em\",\n\t\tcellEllipsis,\n\t\tempty = <Empty />,\n\t\tloading,\n\t\theight = \"unset\",\n\t\tstyle,\n\t\tclassName,\n\t\trenderLoading = () => <Loading size='1.5em' className='color-3' />,\n\t\tonCellClick,\n\t\tonRowClick,\n\t\tonHeaderClick,\n\t\tonSort,\n\t\tonScroll,\n\t\tonResize,\n\t} = props;\n\n\tconst container = useRef<HTMLDivElement>(null);\n\tconst scrollbar = useRef<Scrollbars>(null);\n\tconst state = useReactive<TDatagridState>({\n\t\trows: data,\n\t\twidths: columns.map((col) => col.width ?? \"min-content\"),\n\t\tsortBy: \"\",\n\t\tsortType: \"\",\n\t});\n\n\tconst styles = useMemo(() => {\n\t\tconst { widths } = state;\n\n\t\tconst o = {\n\t\t\t...style,\n\t\t\t\"--grid-template-columns\": widths\n\t\t\t\t.map((w) => {\n\t\t\t\t\treturn typeof w === \"number\" ? `${w}px` : w;\n\t\t\t\t})\n\t\t\t\t.join(\" \"),\n\t\t};\n\n\t\tif (!resizable) return o;\n\n\t\tconst fws = columns.map((col, i) => {\n\t\t\tconst { fixed } = col;\n\t\t\tif (!fixed) return 0;\n\t\t\treturn widths[i] as number;\n\t\t});\n\n\t\tcolumns.map((col, i) => {\n\t\t\tconst { fixed } = col;\n\t\t\tif (!fixed) return;\n\t\t\tif (i === 0) {\n\t\t\t\to[`--datagrid-cell-inset-0`] = 0;\n\t\t\t} else if (i === fws.length - 1) {\n\t\t\t\to[`--datagrid-cell-inset-${fws.length - 1}`] = \"auto 0\";\n\t\t\t} else {\n\t\t\t\tconst isLeft = fixed === \"left\";\n\t\t\t\tconst before = isLeft ? fws.slice(0, i) : fws.slice(i + 1);\n\t\t\t\tconst sum = before.reduce((pre, cur) => pre + cur) + \"px\";\n\t\t\t\tconst result = isLeft ? `${sum} auto` : `auto ${sum}`;\n\t\t\t\to[`--datagrid-cell-inset-${i}`] = result;\n\t\t\t}\n\t\t});\n\n\t\treturn o;\n\t}, [state.widths, resizable]);\n\n\tconst handleWidthChange = (i: number, w: number) => {\n\t\tif (!resizable) return;\n\n\t\tconst [...ws] = state.widths;\n\t\tws[i] = w;\n\t\tstate.widths = ws;\n\t\tonResize?.(columns[i], w);\n\t};\n\n\tconst handleHeaderClick = (column?: IColumn, e?: MouseEvent) => {\n\t\tif (column?.sorter) {\n\t\t\tconst [sortBy, sortType] = getNextSorter(\n\t\t\t\tstate.sortBy,\n\t\t\t\tstate.sortType,\n\t\t\t\tcolumn.id\n\t\t\t);\n\n\t\t\tObject.assign(state, {\n\t\t\t\tsortBy,\n\t\t\t\tsortType,\n\t\t\t});\n\n\t\t\tonSort?.(sortBy, sortType);\n\t\t}\n\n\t\tonHeaderClick?.(column, e);\n\t};\n\n\tconst rows = useMemo(() => {\n\t\tconst { sortBy, sortType } = state;\n\n\t\tif (sortBy && !onSort) {\n\t\t\tconst sorter = columns.find((col) => col.id === sortBy)?.sorter;\n\t\t\tconst sortFn =\n\t\t\t\ttypeof sorter === \"function\"\n\t\t\t\t\t? sorter\n\t\t\t\t\t: (a: IData, b: IData) => b[sortBy] - a[sortBy];\n\t\t\tconst sorted = [...data].sort(sortFn);\n\n\t\t\treturn sortType === \"desc\" ? sorted : sorted.reverse();\n\t\t}\n\n\t\treturn data;\n\t}, [data, columns, state.sortBy, state.sortType]);\n\n\tuseEffect(() => {\n\t\tif (!container.current) return;\n\t\tconst { current: div } = container;\n\t\tconst tds = div.querySelector(\".i-datagrid-row\")?.children;\n\t\tif (!tds?.length) return;\n\t\tstate.widths = Array.from(tds).map((node: any) => node.offsetWidth);\n\t}, [columns, resizable]);\n\n\tuseEffect(() => {\n\t\tloading && scrollbar.current?.scrollTop(0);\n\t}, [loading]);\n\n\tconst scrollBarStyle = {\n\t\t\"--cell-padding\": cellPadding,\n\t\t...styles,\n\t} as CSSProperties;\n\n\treturn (\n\t\t<ScrollContainer\n\t\t\tref={scrollbar}\n\t\t\tautoHide\n\t\t\tautoHeight\n\t\t\tautoHeightMax={height}\n\t\t\tstyle={scrollBarStyle}\n\t\t\tclassName={classNames(\"i-datagrid-container\", className, {\n\t\t\t\t\"i-datagrid-bordered\": border,\n\t\t\t\t\"i-datagrid-striped\": striped,\n\t\t\t})}\n\t\t\trenderView={(props) => (\n\t\t\t\t<div\n\t\t\t\t\t{...props}\n\t\t\t\t\tclassName={classNames({ \"i-datagrid-loading\": loading })}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\tonScroll={onScroll}\n\t\t>\n\t\t\t<div ref={container} className='i-datagrid'>\n\t\t\t\t{header && (\n\t\t\t\t\t<Header\n\t\t\t\t\t\tcolumns={columns}\n\t\t\t\t\t\tresizable={resizable}\n\t\t\t\t\t\tsortType={state.sortType}\n\t\t\t\t\t\tsortBy={state.sortBy}\n\t\t\t\t\t\tcellEllipsis={cellEllipsis}\n\t\t\t\t\t\tonWidthChange={handleWidthChange}\n\t\t\t\t\t\tonHeaderClick={handleHeaderClick}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{rows.map((row, i) => (\n\t\t\t\t\t<Row\n\t\t\t\t\t\tkey={i}\n\t\t\t\t\t\trow={i + (header ? 1 : 0)}\n\t\t\t\t\t\tdata={row}\n\t\t\t\t\t\tcellEllipsis={cellEllipsis}\n\t\t\t\t\t\tcolumns={columns}\n\t\t\t\t\t\tonCellClick={onCellClick}\n\t\t\t\t\t\tonRowClick={onRowClick}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\n\t\t\t\t{rows.length < 1 && empty}\n\t\t\t</div>\n\n\t\t\t{loading && renderLoading()}\n\t\t</ScrollContainer>\n\t);\n};\n\nexport default Datagrid;\n"],"names":["Datagrid","props","data","columns","border","striped","header","resizable","cellPadding","cellEllipsis","empty","_jsx","Empty","loading","height","style","className","renderLoading","Loading","size","onCellClick","onRowClick","onHeaderClick","onSort","onScroll","onResize","container","useRef","scrollbar","state","useReactive","rows","widths","map","col","width","sortBy","sortType","styles","useMemo","o","w","join","fws","i","fixed","length","isLeft","sum","slice","reduce","pre","cur","result","sorter","find","id","sortFn","a","b","sorted","sort","reverse","useEffect","current","div","tds","querySelector","children","Array","from","node","offsetWidth","scrollTop","scrollBarStyle","_jsxs","ScrollContainer","ref","autoHide","autoHeight","autoHeightMax","classNames","renderView","Header","onWidthChange","ws","column","e","getNextSorter","Object","assign","row","Row"],"mappings":"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"}
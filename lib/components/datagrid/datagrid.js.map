{"version":3,"file":"datagrid.js","sources":["../../../packages/components/datagrid/datagrid.tsx"],"sourcesContent":["import { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { CSSProperties, MouseEvent, useEffect, useMemo, useRef } from \"react\";\nimport { getNextSorter } from \"../../js/utils\";\nimport Loading from \"../loading\";\nimport Empty from \"../utils/empty\";\nimport \"./index.css\";\nimport Row, { Header } from \"./row\";\nimport type { IColumn, IData, IDatagrid, TDatagridState } from \"./type\";\n\nconst Datagrid = (props: IDatagrid) => {\n\tconst {\n\t\tdata = [],\n\t\tcolumns = [],\n\t\tborder,\n\t\tstriped,\n\t\theader = true,\n\t\tresizable,\n\t\tcellPadding = \".5em\",\n\t\tcellEllipsis,\n\t\tempty = <Empty />,\n\t\tloading,\n\t\theight = \"unset\",\n\t\tstyle,\n\t\tclassName,\n\t\trenderLoading = () => <Loading size='1.5em' className='color-3' />,\n\t\tonCellClick,\n\t\tonRowClick,\n\t\tonHeaderClick,\n\t\tonSort,\n\t\tonScroll,\n\t\tonResize,\n\t} = props;\n\n\tconst container = useRef<HTMLDivElement>(null);\n\tconst state = useReactive<TDatagridState>({\n\t\trows: data,\n\t\twidths: columns.map((col) => col.width ?? \"min-content\"),\n\t\tsortBy: \"\",\n\t\tsortType: \"\",\n\t});\n\n\tconst styles = useMemo(() => {\n\t\tconst { widths } = state;\n\n\t\tconst o = {\n\t\t\t...style,\n\t\t\t\"--grid-template-columns\": widths\n\t\t\t\t.map((w) => {\n\t\t\t\t\treturn typeof w === \"number\" ? `${w}px` : w;\n\t\t\t\t})\n\t\t\t\t.join(\" \"),\n\t\t};\n\n\t\tif (!resizable) return o;\n\n\t\tconst fws = columns.map((col, i) => {\n\t\t\tconst { fixed } = col;\n\t\t\tif (!fixed) return 0;\n\t\t\treturn widths[i] as number;\n\t\t});\n\n\t\tcolumns.map((col, i) => {\n\t\t\tconst { fixed } = col;\n\t\t\tif (!fixed) return;\n\t\t\tif (i === 0) {\n\t\t\t\to[`--datagrid-cell-inset-0`] = 0;\n\t\t\t} else if (i === fws.length - 1) {\n\t\t\t\to[`--datagrid-cell-inset-${fws.length - 1}`] = \"auto 0\";\n\t\t\t} else {\n\t\t\t\tconst isLeft = fixed === \"left\";\n\t\t\t\tconst before = isLeft ? fws.slice(0, i) : fws.slice(i + 1);\n\t\t\t\tconst sum = before.reduce((pre, cur) => pre + cur) + \"px\";\n\t\t\t\tconst result = isLeft ? `${sum} auto` : `auto ${sum}`;\n\t\t\t\to[`--datagrid-cell-inset-${i}`] = result;\n\t\t\t}\n\t\t});\n\n\t\treturn o;\n\t}, [state.widths, resizable]);\n\n\tconst handleWidthChange = (i: number, w: number) => {\n\t\tif (!resizable) return;\n\n\t\tconst [...ws] = state.widths;\n\t\tws[i] = w;\n\t\tstate.widths = ws;\n\t\tonResize?.(columns[i], w);\n\t};\n\n\tconst handleHeaderClick = (column?: IColumn, e?: MouseEvent) => {\n\t\tif (column?.sorter) {\n\t\t\tconst [sortBy, sortType] = getNextSorter(\n\t\t\t\tstate.sortBy,\n\t\t\t\tstate.sortType,\n\t\t\t\tcolumn.id\n\t\t\t);\n\n\t\t\tObject.assign(state, {\n\t\t\t\tsortBy,\n\t\t\t\tsortType,\n\t\t\t});\n\n\t\t\tonSort?.(sortBy, sortType);\n\t\t}\n\n\t\tonHeaderClick?.(column, e);\n\t};\n\n\tconst rows = useMemo(() => {\n\t\tconst { sortBy, sortType } = state;\n\n\t\tif (sortBy && !onSort) {\n\t\t\tconst sorter = columns.find((col) => col.id === sortBy)?.sorter;\n\t\t\tconst sortFn =\n\t\t\t\ttypeof sorter === \"function\"\n\t\t\t\t\t? sorter\n\t\t\t\t\t: (a: IData, b: IData) => b[sortBy] - a[sortBy];\n\t\t\tconst sorted = [...data].sort(sortFn);\n\n\t\t\treturn sortType === \"desc\" ? sorted : sorted.reverse();\n\t\t}\n\n\t\treturn data;\n\t}, [data, columns, state.sortBy, state.sortType]);\n\n\tuseEffect(() => {\n\t\tif (!container.current) return;\n\t\tconst { current: div } = container;\n\t\tconst tds = div.querySelector(\".i-datagrid-row\")?.children;\n\t\tif (!tds?.length) return;\n\t\tstate.widths = Array.from(tds).map((node: any) => node.offsetWidth);\n\t}, [columns, resizable]);\n\n\tuseEffect(() => {\n\t\tloading && container.current?.scrollTo({ top: 0, left: 0 });\n\t}, [loading]);\n\n\tconst mergedStyle = {\n\t\t\"--cell-padding\": cellPadding,\n\t\t...styles,\n\t} as CSSProperties;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{ maxHeight: height, ...mergedStyle }}\n\t\t\tclassName={classNames(\"i-datagrid-container\", className, {\n\t\t\t\t\"i-datagrid-bordered\": border,\n\t\t\t\t\"i-datagrid-striped\": striped,\n\t\t\t})}\n\t\t>\n\t\t\t<div\n\t\t\t\tref={container}\n\t\t\t\tclassName={classNames(\"i-datagrid\", {\n\t\t\t\t\t\"i-datagrid-loading\": loading,\n\t\t\t\t})}\n\t\t\t\tonWheel={onScroll}\n\t\t\t>\n\t\t\t\t{header && (\n\t\t\t\t\t<Header\n\t\t\t\t\t\tcolumns={columns}\n\t\t\t\t\t\tresizable={resizable}\n\t\t\t\t\t\tsortType={state.sortType}\n\t\t\t\t\t\tsortBy={state.sortBy}\n\t\t\t\t\t\tcellEllipsis={cellEllipsis}\n\t\t\t\t\t\tonWidthChange={handleWidthChange}\n\t\t\t\t\t\tonHeaderClick={handleHeaderClick}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{rows.map((row, i) => (\n\t\t\t\t\t<Row\n\t\t\t\t\t\tkey={i}\n\t\t\t\t\t\trow={i + (header ? 1 : 0)}\n\t\t\t\t\t\tdata={row}\n\t\t\t\t\t\tcellEllipsis={cellEllipsis}\n\t\t\t\t\t\tcolumns={columns}\n\t\t\t\t\t\tonCellClick={onCellClick}\n\t\t\t\t\t\tonRowClick={onRowClick}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\n\t\t\t\t{rows.length < 1 && empty}\n\t\t\t</div>\n\n\t\t\t{loading && renderLoading()}\n\t\t</div>\n\t);\n};\n\nexport default Datagrid;\n"],"names":["Datagrid","props","data","columns","border","striped","header","resizable","cellPadding","cellEllipsis","empty","_jsx","Empty","loading","height","style","className","renderLoading","Loading","size","onCellClick","onRowClick","onHeaderClick","onSort","onScroll","onResize","container","useRef","state","useReactive","rows","widths","map","col","width","sortBy","sortType","styles","useMemo","o","w","join","fws","i","fixed","length","isLeft","sum","slice","reduce","pre","cur","result","sorter","find","id","sortFn","a","b","sorted","sort","reverse","useEffect","current","div","tds","querySelector","children","Array","from","node","offsetWidth","scrollTo","top","left","mergedStyle","_jsxs","maxHeight","classNames","ref","onWheel","Header","onWidthChange","ws","column","e","getNextSorter","Object","assign","row","Row"],"mappings":"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"}
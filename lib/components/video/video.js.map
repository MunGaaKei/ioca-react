{"version":3,"file":"video.js","sources":["../../../packages/components/video/video.tsx"],"sourcesContent":["import { exitFullScreen, fullScreen } from \"@p/js/utils\";\nimport {\n\tFullscreenExitRound,\n\tFullscreenRound,\n\tPauseRound,\n\tPlayArrowRound,\n\tStopRound,\n\tVolumeDownRound,\n\tVolumeOffRound,\n} from \"@ricons/material\";\nimport { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { throttle } from \"radash\";\nimport { useEffect, useImperativeHandle, useRef } from \"react\";\nimport Button from \"../button\";\nimport Icon from \"../icon\";\nimport Progress from \"../progress\";\nimport Text from \"../text\";\nimport \"./index.css\";\nimport { IVideo } from \"./type\";\n\nconst Video = (props: IVideo) => {\n\tconst {\n\t\tref,\n\t\tstyle,\n\t\thideControls,\n\t\tautoplay,\n\t\tmuted,\n\t\tvolume = 50,\n\t\theight,\n\t\twidth,\n\t\tuseOriginControls,\n\t\ttimeProgressProps = {\n\t\t\tbarClass: \"bg-blue\",\n\t\t},\n\t\tvolumeProgressProps = {\n\t\t\tbarClass: \"bg-blue\",\n\t\t},\n\t\tclassName,\n\t\tonFullScreenChange,\n\t\t...restProps\n\t} = props;\n\tconst state = useReactive({\n\t\tplaying: autoplay,\n\t\tvolume: muted ? 0 : volume,\n\t\tvolumeCache: 0,\n\t\tmuted,\n\t\tcurrent: 0,\n\t\tduration: 0,\n\t\tisFullscreen: false,\n\t\tcontrolHidden: true,\n\t\tdraggingProgress: false,\n\t});\n\tconst videoRef = useRef<HTMLVideoElement>(null);\n\tconst hiddenTO = useRef<any>(null);\n\n\tconst timeUpdateListener = (e) => {\n\t\tconst tar = e.target;\n\t\tif (tar.paused || state.draggingProgress) return;\n\n\t\tObject.assign(state, {\n\t\t\tcurrent: tar.currentTime,\n\t\t});\n\t};\n\n\tconst playChangeListener = (e) => {\n\t\tstate.playing = !e.target.paused;\n\t};\n\n\tconst fsChangeListener = () => {\n\t\tconst tar = videoRef.current?.parentElement;\n\t\tif (!tar) return;\n\n\t\tstate.isFullscreen = document.fullscreenElement === tar;\n\t};\n\n\tconst volumeChangeListener = (e) => {\n\t\tconst tar = e.target;\n\t\tObject.assign(state, {\n\t\t\tvolume: tar.volume * 100,\n\t\t\tmuted: tar.volume === 0,\n\t\t});\n\t};\n\n\tconst handlePlay = () => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tv.paused ? v.play() : v.pause();\n\t};\n\n\tconst handleReady = (e) => {\n\t\tconst tar = e.target;\n\t\tObject.assign(state, {\n\t\t\tduration: tar.duration,\n\t\t\tcurrent: tar.currentTime,\n\t\t});\n\t\ttar.volume = state.volume / 100;\n\t};\n\n\tconst handleMuted = () => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tif (v.volume > 0) {\n\t\t\tstate.volumeCache = v.volume;\n\t\t\tv.volume = 0;\n\t\t\treturn;\n\t\t}\n\t\tv.volume = state.volumeCache === 0 ? 0.5 : state.volumeCache;\n\t};\n\n\tconst handleStop = () => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tv.currentTime = 0;\n\t\tv.pause();\n\t};\n\n\tconst handleFullscreen = () => {\n\t\tconst tar = videoRef.current?.parentElement;\n\t\tif (!tar) return;\n\n\t\tstate.isFullscreen ? exitFullScreen() : fullScreen(tar);\n\t\tonFullScreenChange?.(!state.isFullscreen);\n\t};\n\n\tconst handleUpdateTime = (t) => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tv.currentTime = (state.duration * t) / 100;\n\t};\n\n\tconst handleUpdateVolume = (t) => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tv.volume = t / 100;\n\t};\n\n\tconst showControls = !hideControls && !useOriginControls;\n\n\tconst clearHiddenTO = () => {\n\t\tif (!hiddenTO.current) return;\n\t\tclearTimeout(hiddenTO.current);\n\t\thiddenTO.current = null;\n\t};\n\n\tconst setHiddenFalse = () => {\n\t\tif (!showControls || !state.controlHidden) return;\n\t\tstate.controlHidden = false;\n\n\t\tclearHiddenTO();\n\t\thiddenTO.current = setTimeout(() => {\n\t\t\tstate.controlHidden = true;\n\t\t}, 1000);\n\t};\n\n\tconst handleDraggingProgress = (dragging) => {\n\t\tstate.draggingProgress = dragging;\n\t};\n\n\tconst handleMouseMove = throttle({ interval: 900 }, setHiddenFalse);\n\n\tuseImperativeHandle(ref, () => ({\n\t\tplay: () => {\n\t\t\tconst v = videoRef.current;\n\t\t\tif (!v) return;\n\n\t\t\tv.play();\n\t\t},\n\t\tpause: () => {\n\t\t\tconst v = videoRef.current;\n\t\t\tif (!v) return;\n\n\t\t\tv.pause();\n\t\t},\n\t\tstop: handleStop,\n\t\tfullscreen: handleFullscreen,\n\t\tgetVideo: () => videoRef.current,\n\t}));\n\n\tuseEffect(() => {\n\t\tconst v = videoRef.current;\n\t\tif (!v) return;\n\n\t\tv.addEventListener(\"timeupdate\", timeUpdateListener);\n\t\tv.addEventListener(\"play\", playChangeListener);\n\t\tv.addEventListener(\"pause\", playChangeListener);\n\t\tv.addEventListener(\"volumechange\", volumeChangeListener);\n\t\tdocument.addEventListener(\"fullscreenchange\", fsChangeListener);\n\n\t\treturn () => {\n\t\t\tclearHiddenTO();\n\t\t\tv.removeEventListener(\"timeupdate\", timeUpdateListener);\n\t\t\tv.removeEventListener(\"play\", playChangeListener);\n\t\t\tv.removeEventListener(\"pause\", playChangeListener);\n\t\t\tv.removeEventListener(\"volumechange\", volumeChangeListener);\n\t\t\tdocument.removeEventListener(\"fullscreenchange\", fsChangeListener);\n\t\t};\n\t}, []);\n\n\tconst currentValue = (state.current / state.duration) * 100;\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames(\"i-video\", className)}\n\t\t\tstyle={{ height, width, ...style }}\n\t\t\tonClick={handlePlay}\n\t\t\tonDoubleClick={() => handleFullscreen()}\n\t\t\tonMouseMove={handleMouseMove}\n\t\t>\n\t\t\t<video\n\t\t\t\tref={videoRef}\n\t\t\t\tonCanPlay={handleReady}\n\t\t\t\t{...restProps}\n\t\t\t\tcontrols={useOriginControls}\n\t\t\t/>\n\n\t\t\t{showControls && (\n\t\t\t\t<div\n\t\t\t\t\tclassName={classNames(\"i-video-controls\", {\n\t\t\t\t\t\t\"i-video-controls-hidden\": state.controlHidden,\n\t\t\t\t\t})}\n\t\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t\t>\n\t\t\t\t\t<Button.Toggle\n\t\t\t\t\t\tclassName='i-video-btn'\n\t\t\t\t\t\tflat\n\t\t\t\t\t\tsquare\n\t\t\t\t\t\tafter={<Icon icon={<PauseRound />} />}\n\t\t\t\t\t\tactive={state.playing}\n\t\t\t\t\t\tonClick={handlePlay}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Icon icon={<PlayArrowRound />} />\n\t\t\t\t\t</Button.Toggle>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclassName='i-video-btn'\n\t\t\t\t\t\tflat\n\t\t\t\t\t\tsquare\n\t\t\t\t\t\tonClick={handleStop}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Icon icon={<StopRound />} />\n\t\t\t\t\t</Button>\n\t\t\t\t\t<span className='i-video-times font-sm'>\n\t\t\t\t\t\t<Text.Time seconds={state.current} /> /\n\t\t\t\t\t\t<Text.Time seconds={state.duration} />\n\t\t\t\t\t</span>\n\t\t\t\t\t<Progress\n\t\t\t\t\t\t{...timeProgressProps}\n\t\t\t\t\t\tvalue={currentValue}\n\t\t\t\t\t\tonChange={handleUpdateTime}\n\t\t\t\t\t\tonDraggingChange={handleDraggingProgress}\n\t\t\t\t\t/>\n\n\t\t\t\t\t<div className='i-video-control-volume'>\n\t\t\t\t\t\t<Button.Toggle\n\t\t\t\t\t\t\tclassName='i-video-btn'\n\t\t\t\t\t\t\tflat\n\t\t\t\t\t\t\tsquare\n\t\t\t\t\t\t\tactive={state.volume <= 0}\n\t\t\t\t\t\t\tafter={\n\t\t\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\t\t\ticon={<VolumeOffRound />}\n\t\t\t\t\t\t\t\t\tstyle={{ padding: \".125em\" }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonClick={handleMuted}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Icon icon={<VolumeDownRound />} />\n\t\t\t\t\t\t</Button.Toggle>\n\n\t\t\t\t\t\t<div className='i-video-volume'>\n\t\t\t\t\t\t\t<Progress\n\t\t\t\t\t\t\t\tstyle={{ height: 100 }}\n\t\t\t\t\t\t\t\tvertical\n\t\t\t\t\t\t\t\t{...volumeProgressProps}\n\t\t\t\t\t\t\t\tvalue={state.volume}\n\t\t\t\t\t\t\t\tonChange={handleUpdateVolume}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<Button.Toggle\n\t\t\t\t\t\tclassName='i-video-btn'\n\t\t\t\t\t\tflat\n\t\t\t\t\t\tsquare\n\t\t\t\t\t\tafter={<Icon icon={<FullscreenExitRound />} />}\n\t\t\t\t\t\tactive={state.isFullscreen}\n\t\t\t\t\t\tonClick={() => handleFullscreen()}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Icon icon={<FullscreenRound />} />\n\t\t\t\t\t</Button.Toggle>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default Video;\n"],"names":["Video","props","ref","style","hideControls","autoplay","muted","volume","height","width","useOriginControls","timeProgressProps","barClass","volumeProgressProps","className","onFullScreenChange","restProps","state","useReactive","playing","volumeCache","current","duration","isFullscreen","controlHidden","draggingProgress","videoRef","useRef","hiddenTO","timeUpdateListener","e","tar","target","paused","Object","assign","currentTime","playChangeListener","fsChangeListener","parentElement","document","fullscreenElement","volumeChangeListener","handlePlay","v","play","pause","handleStop","handleFullscreen","exitFullScreen","fullScreen","showControls","clearHiddenTO","clearTimeout","handleMouseMove","throttle","interval","setTimeout","useImperativeHandle","stop","fullscreen","getVideo","useEffect","addEventListener","removeEventListener","currentValue","_jsxs","classNames","onClick","onDoubleClick","onMouseMove","children","_jsx","onCanPlay","controls","stopPropagation","Button","Toggle","flat","square","after","Icon","icon","PauseRound","active","PlayArrowRound","StopRound","Text","Time","seconds","Progress","value","onChange","t","onDraggingChange","dragging","VolumeOffRound","padding","VolumeDownRound","vertical","FullscreenExitRound","FullscreenRound"],"mappings":"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"}
import{jsxs as e,jsx as t}from"react/jsx-runtime";import{MoreHorizRound as r}from"@ricons/material";import{useReactive as a,useSize as i}from"ahooks";import n from"classnames";import{pick as s}from"radash";import{useRef as o,useEffect as c,Children as l,useImperativeHandle as v}from"react";import{useIntersectionObserver as d}from"../../js/hooks.js";import"../button/index.js";import p from"../icon/icon.js";import m from"../popup/popup.js";import f from"../utils/helpericon/helpericon.js";import b from"./item.js";import u from"../button/button.js";const h=b=>{const{ref:h,active:y,tabs:k,type:g="default",prepend:N,append:j,children:w,className:x,vertical:T,toggable:$,navsJustify:C="start",bar:D=!0,hideMore:I,barClass:M,renderMore:S=()=>t(u,{flat:!0,square:!0,size:"small",children:t(p,{icon:t(r,{})})}),onTabChange:A,...L}=b,O=o([]),E=o(null),H=o(null),P=a({active:y,prevActive:void 0,barStyle:{},cachedTabs:[],overflow:!1,more:[],tabs:[]}),{observe:W,unobserve:q}=d(),z=i(H);c((()=>{if(!k)return w?void(P.tabs=l.map(w,((e,t)=>{const{key:r,props:a}=e,{title:i,children:n,content:o,keepDOM:c}=a,l=n?"string"==typeof n?n:s(n,["props","type","$$typeof","ref"]):o;return{key:r||String(t),title:i,content:l,keepDOM:c}}))):void(P.tabs=[]);P.tabs=k.map(((e,t)=>["string","number"].includes(typeof e)?{key:e,title:e}:(void 0===e.key&&(e.key=t),e)))}),[w,k]);const B=e=>{const{key:t}=e,r=P.tabs.findIndex((e=>e.key===t));if(r>-1)return void X(P.tabs[r].key??r);const a=P.tabs.length,i=e.key??a;P.tabs.push({...e,key:i}),X(i)},J=e=>{const t=P.tabs.findIndex((t=>t.key===e));if(t<0)return;if(P.tabs.splice(t,1),P.active!==e)return;const r=P.tabs[t]||P.tabs[t-1];X(P.prevActive??r?.key??"")},X=e=>{if(e===P.active){if(!$)return;return A?.(void 0,e),P.active=void 0,void(P.barStyle={height:0,width:0})}P.prevActive=P.active,A?.(e,P.active),P.active=e};return c((()=>{if(!z||I)return;const{scrollHeight:e,scrollWidth:t}=H.current,{width:r,height:a}=z;P.overflow=e>a||t>r,P.overflow&&O.current.map(((e,t)=>{e&&W(e,((e,r)=>{P.tabs[t]&&(P.tabs[t].intersecting=r,P.more=P.tabs.filter((e=>!e.intersecting)))}))}))}),[z,I,P.tabs.length]),c((()=>{if(!D||"pane"===g||void 0===P.active)return;const e=P.tabs.findIndex((e=>e.key===P.active));setTimeout((()=>{const t=O.current[e];if(!t)return;if(P.tabs[e].keepDOM&&P.active){P.cachedTabs.findIndex((e=>e===P.active))<0&&P.cachedTabs.unshift(P.active)}const{offsetHeight:r,offsetLeft:a,offsetTop:i,offsetWidth:n}=t,s="line"===g;P.barStyle={height:!T&&s?".25em":r,width:T&&s?".25em":n,transform:`translate(${a}px, ${i}px)`}}),16)}),[P.active,D,z]),c((()=>{void 0!==y&&P.active!==y&&X(y)}),[y]),c((()=>{if(!I)return()=>{O.current?.map(q)}}),[P.tabs.length]),c((()=>{if(!H.current||T)return;const e=e=>{e.stopPropagation(),e.preventDefault(),T||H.current?.scrollBy({left:e.deltaY+e.deltaX})};return H.current.addEventListener("wheel",e,{passive:!1}),()=>{H.current&&H.current.removeEventListener("wheel",e)}}),[H.current]),v(h,(()=>({open:X,close:J,add:B,navs:H}))),e("div",{className:n("i-tabs",{flex:T,[`i-tabs-${g}`]:"default"!==g},x),...L,children:[e("div",{className:n("i-tab-navs-container",{"i-tab-navs-vertical":T}),children:[N,e("div",{ref:H,className:n("i-tab-navs",`justify-${C}`),children:[P.tabs.map(((r,a)=>{const{title:i,key:s=a,closable:o}=r;return e("a",{ref:e=>O.current[a]=e,className:n("i-tab-nav",{"i-tab-active":P.active===s}),onClick:()=>X(s),children:[i,o&&t(f,{as:"i",active:!0,className:"i-tab-nav-close",onClick:e=>{e.stopPropagation(),J(s)}})]},s)})),D&&t("span",{ref:E,className:n("i-tab-navs-bar",M),style:P.barStyle})]}),!I&&P.overflow&&P.more.length>0&&t(m,{arrow:!1,position:T?"right":"bottom",align:"end",touchable:!0,hideDelay:500,content:t("div",{className:"i-tabs-morelist pd-4",children:P.more.map(((e,r)=>{const{key:a=r,title:i}=e,s=P.active===a;return t("a",{className:n("i-tab-nav",{"i-tab-active":s}),onClick:()=>X(a),children:i},a)}))}),children:S(P.more)}),j]}),t("div",{className:"i-tab-contents",children:P.tabs.map(((e,r)=>{const{key:a=r,content:i}=e,s=P.active===a;return(s||void 0!==a&&P.cachedTabs.includes(a))&&t("div",{className:n("i-tab-content",{"i-tab-active":s}),children:i},a)}))})]})};h.Item=b;export{h as default};
//# sourceMappingURL=tabs.js.map

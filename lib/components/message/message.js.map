{"version":3,"file":"message.js","sources":["../../../packages/components/message/message.tsx"],"sourcesContent":["import { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { uid } from \"radash\";\nimport { ReactNode, isValidElement, useEffect, useRef } from \"react\";\nimport { createRoot } from \"react-dom/client\";\nimport \"./index.css\";\nimport type { IMessage, IMessageItem, THeights, TMessageQueue } from \"./type\";\n\nconst AlignMap = {\n\tleft: \"flex-start\",\n\tcenter: \"center\",\n\tright: \"flex-end\",\n};\n\nconst GlobalConfig = {\n\talign: \"center\",\n\toffset: \"12px\",\n\tgap: 12,\n};\n\nconst ItemDefaultConfig = {\n\tduration: 3000,\n\tclosable: true,\n\tactive: false,\n};\n\nconst container = createContainer();\nconst handler: {\n\toneInstance: null | IMessage;\n\tcallout: (item: IMessage) => void;\n\tclose: () => void;\n} = {\n\toneInstance: null,\n\tcallout(item: IMessage) {},\n\tclose() {},\n};\n\nconst queue: TMessageQueue = {\n\tleft: [],\n\tcenter: [],\n\tright: [],\n};\nconst heights: THeights = {\n\tleft: [],\n\tcenter: [],\n\tright: [],\n};\n\ncreateRoot(container).render(<Messages />);\n\nconst MessageItem = function ({\n\tref,\n\tactive,\n\tcontent,\n\ttop,\n\tclassName,\n\tstyle,\n\tonClick,\n}: IMessageItem) {\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tclassName={classNames(\"i-message\", className, {\n\t\t\t\t\"i-message-active\": active,\n\t\t\t})}\n\t\t\tstyle={{\n\t\t\t\t...style,\n\t\t\t\ttop,\n\t\t\t}}\n\t\t\tonClick={onClick}\n\t\t>\n\t\t\t{content}\n\t\t</div>\n\t);\n};\n\nfunction Messages() {\n\tconst ref = useRef<HTMLDivElement>(null);\n\tconst state = useReactive<{\n\t\ttops: THeights;\n\t\titems: TMessageQueue;\n\t}>({\n\t\titems: {\n\t\t\tleft: [],\n\t\t\tcenter: [],\n\t\t\tright: [],\n\t\t},\n\t\ttops: {\n\t\t\tleft: [],\n\t\t\tcenter: [],\n\t\t\tright: [],\n\t\t},\n\t});\n\tconst offsetTop = {\n\t\tleft: 0,\n\t\tcenter: 0,\n\t\tright: 0,\n\t};\n\n\tuseEffect(() => {\n\t\tObject.assign(handler, {\n\t\t\tcallout: function (item: IMessage) {\n\t\t\t\tconst { align = \"center\", unshift, onShow } = item;\n\t\t\t\tconst size = queue[align][unshift ? \"unshift\" : \"push\"](item);\n\t\t\t\tstate.items[align] = [...queue[align]];\n\t\t\t\titem.close = this.close.bind(item);\n\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tconst h = ref.current?.offsetHeight || 0;\n\n\t\t\t\t\tqueue[align][unshift ? 0 : size - 1].active = true;\n\t\t\t\t\tstate.items[align] = [...queue[align]];\n\t\t\t\t\theights[align][unshift ? \"unshift\" : \"push\"](h);\n\t\t\t\t\tstate.tops[align] = [...heights[align]];\n\t\t\t\t\tonShow?.();\n\t\t\t\t}, 12);\n\n\t\t\t\tif (item.duration !== 0) {\n\t\t\t\t\titem.timer = setTimeout(() => {\n\t\t\t\t\t\tthis.close.call(item);\n\t\t\t\t\t}, item.duration);\n\t\t\t\t}\n\t\t\t},\n\t\t\tclose: function () {\n\t\t\t\tconst item = this as IMessage;\n\t\t\t\tconst { align = \"center\", onHide } = item;\n\t\t\t\tconst index = queue[align].findIndex((i) => i.id === item.id);\n\t\t\t\tif (index < 0) return;\n\n\t\t\t\tqueue[align][index].active = false;\n\t\t\t\tstate.items[align] = [...queue[align]];\n\n\t\t\t\titem.timer = setTimeout(() => {\n\t\t\t\t\tconst index = queue[align].findIndex(\n\t\t\t\t\t\t(i) => i.id === item.id\n\t\t\t\t\t);\n\n\t\t\t\t\tqueue[align].splice(index, 1);\n\t\t\t\t\theights[align].splice(index, 1);\n\t\t\t\t\tstate.tops[align] = [...heights[align]];\n\t\t\t\t\tstate.items[align] = [...queue[align]];\n\t\t\t\t\titem.timer && clearTimeout(item.timer);\n\t\t\t\t\tonHide?.();\n\t\t\t\t}, 240);\n\t\t\t},\n\t\t});\n\t}, []);\n\n\tconst renderItems = (item, i) => {\n\t\tif (!item) return <></>;\n\n\t\tconst { id, active, content, align = \"center\", className } = item;\n\t\toffsetTop[align] += state.tops[align][i - 1] || 0;\n\t\tconst top = GlobalConfig.gap * i + offsetTop[align];\n\n\t\treturn (\n\t\t\t<MessageItem\n\t\t\t\tkey={id}\n\t\t\t\tref={ref}\n\t\t\t\tactive={active}\n\t\t\t\tcontent={content}\n\t\t\t\ttop={top}\n\t\t\t\tclassName={className}\n\t\t\t\tstyle={{ alignSelf: AlignMap[align] }}\n\t\t\t\tonClick={handler.close.bind(item)}\n\t\t\t/>\n\t\t);\n\t};\n\n\treturn (\n\t\t<div className='i-messages'>\n\t\t\t{state.items.left.map(renderItems)}\n\t\t\t{state.items.center.map(renderItems)}\n\t\t\t{state.items.right.map(renderItems)}\n\t\t</div>\n\t);\n}\n\nexport function setMessageConfig(config: IMessage) {\n\tObject.assign(GlobalConfig, config);\n}\n\nfunction message(config: IMessage | ReactNode) {\n\tif (\n\t\t[\"string\", \"number\"].includes(typeof config) ||\n\t\tisValidElement(config)\n\t) {\n\t\tconfig = { content: config as ReactNode };\n\t}\n\n\tconfig = Object.assign(\n\t\t{ id: uid(7) },\n\t\tItemDefaultConfig,\n\t\tconfig as IMessage\n\t);\n\n\thandler.callout(config as IMessage);\n\n\treturn {\n\t\tinstance: config,\n\t\tclose: handler.close.bind(config),\n\t};\n}\n\nfunction createContainer() {\n\tconst container = document.createElement(\"div\");\n\tcontainer.dataset.id = \"messages\";\n\tdocument.body.append(container);\n\n\treturn container;\n}\n\nmessage.error = (content: ReactNode) => {\n\treturn message({\n\t\tcontent,\n\t\tclassName: \"bg-error\",\n\t});\n};\n\nmessage.success = (content: ReactNode) => {\n\treturn message({\n\t\tcontent,\n\t\tclassName: \"bg-success\",\n\t});\n};\n\nmessage.warning = (content: ReactNode) => {\n\treturn message({\n\t\tcontent,\n\t\tclassName: \"bg-warning\",\n\t});\n};\n\nmessage.one = (config: IMessage) => {\n\tconst o = handler.oneInstance;\n\n\tif (o) {\n\t\tif (o.active && o.duration !== 0) {\n\t\t\tclearTimeout(o.timer);\n\t\t\to.timer = setTimeout(() => {\n\t\t\t\to.close?.();\n\t\t\t}, o.duration);\n\t\t} else {\n\t\t\thandler.callout(o);\n\t\t}\n\t} else {\n\t\tconst { instance } = message(config);\n\t\thandler.oneInstance = instance;\n\t}\n};\n\nexport default message;\n"],"names":["AlignMap","left","center","right","GlobalConfig","ItemDefaultConfig","duration","closable","active","container","document","createElement","dataset","id","body","append","createContainer","handler","oneInstance","callout","item","close","queue","heights","createRoot","render","_jsx","ref","useRef","state","useReactive","items","tops","offsetTop","useEffect","Object","assign","align","unshift","onShow","size","this","bind","setTimeout","h","current","offsetHeight","timer","call","onHide","index","findIndex","i","splice","clearTimeout","renderItems","content","className","top","MessageItem","style","alignSelf","onClick","_jsxs","children","map","classNames","message","config","includes","isValidElement","uid","instance","error","success","warning","one","o"],"mappings":"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"}
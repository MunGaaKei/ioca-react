{"version":3,"file":"image.js","sources":["../../../packages/components/image/image.tsx"],"sourcesContent":["import { useIntersectionObserver } from \"@p/js/hooks\";\nimport usePreview from \"@p/js/usePreview\";\nimport { TFileType } from \"@p/js/usePreview/type\";\nimport { HideImageTwotone } from \"@ricons/material\";\nimport { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { useEffect, useRef } from \"react\";\nimport Icon from \"../icon\";\nimport Loading from \"../loading\";\nimport \"./index.css\";\nimport { CompositionImage, IImage } from \"./type\";\n\nconst Image = (props: IImage) => {\n\tconst {\n\t\tsrc,\n\t\tround,\n\t\tsize,\n\t\tinitSize,\n\t\tlazyload,\n\t\tfallback = (\n\t\t\t<Icon icon={<HideImageTwotone />} size='2em' className='color-5' />\n\t\t),\n\t\tfit,\n\t\tstyle,\n\t\tclassName,\n\t\tcover,\n\t\tcoverClass,\n\t\tusePreview: previewable,\n\t\tonLoad,\n\t\tonError,\n\t\tonClick,\n\t\t...restProps\n\t} = props;\n\n\tconst state = useReactive<{ status?: string }>({\n\t\tstatus: \"loading\",\n\t});\n\tconst ref = useRef<HTMLImageElement>(null);\n\tconst wh = fit ? \"100%\" : undefined;\n\n\tconst { observe, unobserve } = useIntersectionObserver();\n\tconst preview = usePreview();\n\n\tconst handleError = (err) => {\n\t\tonError?.(err);\n\t\tstate.status = \"error\";\n\t};\n\n\tconst handleLoad = (e) => {\n\t\tonLoad?.(e);\n\t\tstate.status = undefined;\n\t};\n\n\tconst handleClick = (e) => {\n\t\tonClick?.(e);\n\n\t\tpreviewable &&\n\t\t\tsrc &&\n\t\t\tpreview({\n\t\t\t\titems: [\n\t\t\t\t\t{\n\t\t\t\t\t\tsrc,\n\t\t\t\t\t\ttype: TFileType.IMAGE,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t};\n\n\tuseEffect(() => {\n\t\tif (!src) return;\n\n\t\tif (!ref.current?.complete) {\n\t\t\tstate.status = \"loading\";\n\t\t}\n\n\t\tif (!lazyload || !ref.current) return;\n\n\t\tobserve(ref.current, (tar: HTMLElement, visible: boolean) => {\n\t\t\tif (!visible) return;\n\n\t\t\ttar.setAttribute(\"src\", tar.dataset.src || \"\");\n\t\t\tunobserve(tar);\n\t\t});\n\n\t\treturn () => {\n\t\t\tref.current && unobserve(ref.current);\n\t\t};\n\t}, [src]);\n\n\trestProps[lazyload ? \"data-src\" : \"src\"] = src;\n\tconst iSize = state.status === \"loading\" ? initSize : undefined;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\twidth: size ?? iSize,\n\t\t\t\theight: size ?? iSize,\n\t\t\t\t...style,\n\t\t\t}}\n\t\t\tclassName={classNames(\"i-image\", className, {\n\t\t\t\trounded: round,\n\t\t\t\t[`i-image-${state.status}`]: state.status,\n\t\t\t})}\n\t\t>\n\t\t\t{state.status === \"error\" ? (\n\t\t\t\tfallback\n\t\t\t) : (\n\t\t\t\t<>\n\t\t\t\t\t{src && (\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tref={ref}\n\t\t\t\t\t\t\tstyle={{ objectFit: fit, width: wh, height: wh }}\n\t\t\t\t\t\t\t{...restProps}\n\t\t\t\t\t\t\tonLoad={handleLoad}\n\t\t\t\t\t\t\tonError={handleError}\n\t\t\t\t\t\t\tonClick={handleClick}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{src && state.status === \"loading\" && <Loading absolute />}\n\n\t\t\t\t\t{cover && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclassName={classNames(\"i-image-cover\", coverClass)}\n\t\t\t\t\t\t\tonClick={handleClick}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{cover}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default Image as CompositionImage;\n"],"names":["Image","props","src","round","size","initSize","lazyload","fallback","_jsx","Icon","icon","HideImageTwotone","className","fit","style","cover","coverClass","usePreview","previewable","onLoad","onError","onClick","restProps","state","useReactive","status","ref","useRef","wh","undefined","observe","unobserve","useIntersectionObserver","preview","handleClick","e","items","type","TFileType","IMAGE","useEffect","current","complete","tar","visible","setAttribute","dataset","iSize","width","height","classNames","rounded","children","_jsxs","objectFit","err","Loading","absolute"],"mappings":"qcAYA,MAAMA,EAASC,IACd,MAAMC,IACLA,EAAGC,MACHA,EAAKC,KACLA,EAAIC,SACJA,EAAQC,SACRA,EAAQC,SACRA,EACCC,EAACC,EAAI,CAACC,KAAMF,EAACG,EAAmB,CAAA,GAAEP,KAAK,MAAMQ,UAAU,YACvDC,IACDA,EAAGC,MACHA,EAAKF,UACLA,EAASG,MACTA,EAAKC,WACLA,EACAC,WAAYC,EAAWC,OACvBA,EAAMC,QACNA,EAAOC,QACPA,KACGC,GACArB,EAEEsB,EAAQC,EAAiC,CAC9CC,OAAQ,YAEHC,EAAMC,EAAyB,MAC/BC,EAAKf,EAAM,YAASgB,GAEpBC,QAAEA,EAAOC,UAAEA,GAAcC,IACzBC,EAAUhB,IAYViB,EAAeC,IACpBd,IAAUc,GAEVjB,GACChB,GACA+B,EAAQ,CACPG,MAAO,CACN,CACClC,MACAmC,KAAMC,EAAUC,SAGjB,EAGJC,GAAU,KACT,GAAKtC,IAEAwB,EAAIe,SAASC,WACjBnB,EAAME,OAAS,WAGXnB,GAAaoB,EAAIe,SAStB,OAPAX,EAAQJ,EAAIe,SAAS,CAACE,EAAkBC,KAClCA,IAELD,EAAIE,aAAa,MAAOF,EAAIG,QAAQ5C,KAAO,IAC3C6B,EAAUY,GAAI,IAGR,KACNjB,EAAIe,SAAWV,EAAUL,EAAIe,QAAQ,CACrC,GACC,CAACvC,IAEJoB,EAAUhB,EAAW,WAAa,OAASJ,EAC3C,MAAM6C,EAAyB,YAAjBxB,EAAME,OAAuBpB,OAAWwB,EAEtD,OACCrB,EACC,MAAA,CAAAM,MAAO,CACNkC,MAAO5C,GAAQ2C,EACfE,OAAQ7C,GAAQ2C,KACbjC,GAEJF,UAAWsC,EAAW,UAAWtC,EAAW,CAC3CuC,QAAShD,EACT,CAAC,WAAWoB,EAAME,UAAWF,EAAME,SAClC2B,SAEgB,UAAjB7B,EAAME,OAAkB,EAGxB4B,eACEnD,GACAM,EACC,MAAA,CAAAkB,IAAKA,EACLZ,MAAO,CAAEwC,UAAWzC,EAAKmC,MAAOpB,EAAIqB,OAAQrB,MACxCN,EACJH,OAjEcgB,IACnBhB,IAASgB,GACTZ,EAAME,YAASI,CAAS,EAgEnBT,QAvEemC,IACpBnC,IAAUmC,GACVhC,EAAME,OAAS,OAAO,EAsEjBJ,QAASa,IAIVhC,GAAwB,YAAjBqB,EAAME,QAAwBjB,EAACgD,EAAO,CAACC,UAAQ,IAEtD1C,GACAP,EAAA,MAAA,CACCI,UAAWsC,EAAW,gBAAiBlC,GACvCK,QAASa,WAERnB,QAKA"}
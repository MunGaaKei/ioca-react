{"version":3,"file":"message.js","sources":["../../../../packages/components/message/message.tsx"],"sourcesContent":["import { useReactive } from \"ahooks\";\r\nimport classNames from \"classnames\";\r\nimport { uid } from \"radash\";\r\nimport { ReactNode, isValidElement, useEffect, useRef } from \"react\";\r\nimport { createRoot } from \"react-dom/client\";\r\nimport \"./index.css\";\r\nimport type { IMessage, IMessageItem, THeights, TMessageQueue } from \"./type\";\r\n\r\nconst AlignMap = {\r\n\tleft: \"flex-start\",\r\n\tcenter: \"center\",\r\n\tright: \"flex-end\",\r\n};\r\n\r\nconst GlobalConfig = {\r\n\talign: \"center\",\r\n\toffset: \"12px\",\r\n\tgap: 12,\r\n};\r\n\r\nconst ItemDefaultConfig = {\r\n\tduration: 3000,\r\n\tclosable: true,\r\n\tactive: false,\r\n};\r\n\r\nconst handler: {\r\n\toneInstance: null | IMessage;\r\n\tcallout: (item: IMessage) => void;\r\n\tclose: () => void;\r\n} = {\r\n\toneInstance: null,\r\n\tcallout(item: IMessage) {},\r\n\tclose() {},\r\n};\r\n\r\nconst queue: TMessageQueue = {\r\n\tleft: [],\r\n\tcenter: [],\r\n\tright: [],\r\n};\r\nconst heights: THeights = {\r\n\tleft: [],\r\n\tcenter: [],\r\n\tright: [],\r\n};\r\n\r\nconst MessageItem = function ({\r\n\tref,\r\n\tactive,\r\n\tcontent,\r\n\ttop,\r\n\tclassName,\r\n\tstyle,\r\n\tonClick,\r\n}: IMessageItem) {\r\n\treturn (\r\n\t\t<div\r\n\t\t\tref={ref}\r\n\t\t\tclassName={classNames(\"i-message\", className, {\r\n\t\t\t\t\"i-message-active\": active,\r\n\t\t\t})}\r\n\t\t\tstyle={{\r\n\t\t\t\t...style,\r\n\t\t\t\ttop,\r\n\t\t\t}}\r\n\t\t\tonClick={onClick}\r\n\t\t>\r\n\t\t\t{content}\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nfunction Messages() {\r\n\tconst ref = useRef<HTMLDivElement>(null);\r\n\tconst state = useReactive<{\r\n\t\ttops: THeights;\r\n\t\titems: TMessageQueue;\r\n\t}>({\r\n\t\titems: {\r\n\t\t\tleft: [],\r\n\t\t\tcenter: [],\r\n\t\t\tright: [],\r\n\t\t},\r\n\t\ttops: {\r\n\t\t\tleft: [],\r\n\t\t\tcenter: [],\r\n\t\t\tright: [],\r\n\t\t},\r\n\t});\r\n\tconst offsetTop = {\r\n\t\tleft: 0,\r\n\t\tcenter: 0,\r\n\t\tright: 0,\r\n\t};\r\n\r\n\tuseEffect(() => {\r\n\t\tObject.assign(handler, {\r\n\t\t\tcallout: function (item: IMessage) {\r\n\t\t\t\tconst { align = \"center\", unshift, onShow } = item;\r\n\t\t\t\tconst size = queue[align][unshift ? \"unshift\" : \"push\"](item);\r\n\t\t\t\tstate.items[align] = [...queue[align]];\r\n\t\t\t\titem.close = this.close.bind(item);\r\n\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tconst h = ref.current?.offsetHeight || 0;\r\n\r\n\t\t\t\t\tqueue[align][unshift ? 0 : size - 1].active = true;\r\n\t\t\t\t\tstate.items[align] = [...queue[align]];\r\n\t\t\t\t\theights[align][unshift ? \"unshift\" : \"push\"](h);\r\n\t\t\t\t\tstate.tops[align] = [...heights[align]];\r\n\t\t\t\t\tonShow?.();\r\n\t\t\t\t}, 12);\r\n\r\n\t\t\t\tif (item.duration !== 0) {\r\n\t\t\t\t\titem.timer = setTimeout(() => {\r\n\t\t\t\t\t\tthis.close.call(item);\r\n\t\t\t\t\t}, item.duration);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tclose: function () {\r\n\t\t\t\tconst item = this as IMessage;\r\n\t\t\t\tconst { align = \"center\", onHide } = item;\r\n\t\t\t\tconst index = queue[align].findIndex((i) => i.id === item.id);\r\n\t\t\t\tif (index < 0) return;\r\n\r\n\t\t\t\tqueue[align][index].active = false;\r\n\t\t\t\tstate.items[align] = [...queue[align]];\r\n\r\n\t\t\t\titem.timer = setTimeout(() => {\r\n\t\t\t\t\tconst index = queue[align].findIndex(\r\n\t\t\t\t\t\t(i) => i.id === item.id\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tqueue[align].splice(index, 1);\r\n\t\t\t\t\theights[align].splice(index, 1);\r\n\t\t\t\t\tstate.tops[align] = [...heights[align]];\r\n\t\t\t\t\tstate.items[align] = [...queue[align]];\r\n\t\t\t\t\titem.timer && clearTimeout(item.timer);\r\n\t\t\t\t\tonHide?.();\r\n\t\t\t\t}, 240);\r\n\t\t\t},\r\n\t\t});\r\n\t}, []);\r\n\r\n\tconst renderItems = (item, i) => {\r\n\t\tif (!item) return <></>;\r\n\r\n\t\tconst { id, active, content, align = \"center\", className } = item;\r\n\t\toffsetTop[align] += state.tops[align][i - 1] || 0;\r\n\t\tconst top = GlobalConfig.gap * i + offsetTop[align];\r\n\r\n\t\treturn (\r\n\t\t\t<MessageItem\r\n\t\t\t\tkey={id}\r\n\t\t\t\tref={ref}\r\n\t\t\t\tactive={active}\r\n\t\t\t\tcontent={content}\r\n\t\t\t\ttop={top}\r\n\t\t\t\tclassName={className}\r\n\t\t\t\tstyle={{ alignSelf: AlignMap[align] }}\r\n\t\t\t\tonClick={handler.close.bind(item)}\r\n\t\t\t/>\r\n\t\t);\r\n\t};\r\n\r\n\treturn (\r\n\t\t<div className='i-messages'>\r\n\t\t\t{state.items.left.map(renderItems)}\r\n\t\t\t{state.items.center.map(renderItems)}\r\n\t\t\t{state.items.right.map(renderItems)}\r\n\t\t</div>\r\n\t);\r\n}\r\n\r\nexport function setMessageConfig(config: IMessage) {\r\n\tObject.assign(GlobalConfig, config);\r\n}\r\n\r\nfunction message(config: IMessage | ReactNode) {\r\n\tif (\r\n\t\t[\"string\", \"number\"].includes(typeof config) ||\r\n\t\tisValidElement(config)\r\n\t) {\r\n\t\tconfig = { content: config as ReactNode };\r\n\t}\r\n\r\n\tconfig = Object.assign(\r\n\t\t{ id: uid(7) },\r\n\t\tItemDefaultConfig,\r\n\t\tconfig as IMessage\r\n\t);\r\n\r\n\thandler.callout(config as IMessage);\r\n\r\n\treturn {\r\n\t\tinstance: config,\r\n\t\tclose: handler.close.bind(config),\r\n\t};\r\n}\r\n\r\nfunction createContainer() {\r\n\tif (typeof document === \"undefined\") return null;\r\n\tconst container = document.createElement(\"div\");\r\n\tcontainer.dataset.id = \"messages\";\r\n\tdocument.body.append(container);\r\n\treturn container;\r\n}\r\n\r\nmessage.error = (content: ReactNode) => {\r\n\treturn message({\r\n\t\tcontent,\r\n\t\tclassName: \"bg-error\",\r\n\t});\r\n};\r\n\r\nmessage.success = (content: ReactNode) => {\r\n\treturn message({\r\n\t\tcontent,\r\n\t\tclassName: \"bg-success\",\r\n\t});\r\n};\r\n\r\nmessage.warning = (content: ReactNode) => {\r\n\treturn message({\r\n\t\tcontent,\r\n\t\tclassName: \"bg-warning\",\r\n\t});\r\n};\r\n\r\nmessage.info = (content: ReactNode) => {\r\n\treturn message({\r\n\t\tcontent,\r\n\t\tclassName: \"bg-blue\",\r\n\t});\r\n};\r\n\r\nmessage.one = (config: IMessage) => {\r\n\tconst o = handler.oneInstance;\r\n\r\n\tif (o) {\r\n\t\tif (o.active && o.duration !== 0) {\r\n\t\t\tclearTimeout(o.timer);\r\n\t\t\to.timer = setTimeout(() => {\r\n\t\t\t\to.close?.();\r\n\t\t\t}, o.duration);\r\n\t\t} else {\r\n\t\t\thandler.callout(o);\r\n\t\t}\r\n\t} else {\r\n\t\tconst { instance } = message(config);\r\n\t\thandler.oneInstance = instance;\r\n\t}\r\n};\r\n\r\n// 初始化消息容器\r\nlet container: HTMLElement | null = null;\r\nlet root: any = null;\r\n\r\nif (typeof window !== \"undefined\") {\r\n\tcontainer = createContainer();\r\n\tif (container) {\r\n\t\troot = createRoot(container);\r\n\t\troot.render(<Messages />);\r\n\t}\r\n}\r\n\r\nexport default message;\r\n"],"names":["_jsx","_jsxs"],"mappings":"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"}
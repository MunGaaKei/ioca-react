{"version":3,"file":"field.js","sources":["../../../../packages/components/form/field.tsx"],"sourcesContent":["import { useReactive } from \"ahooks\";\r\nimport PubSub from \"pubsub-js\";\r\nimport {\r\n\tChildren,\r\n\tcloneElement,\r\n\tisValidElement,\r\n\tuseContext,\r\n\tuseEffect,\r\n\tuseMemo,\r\n} from \"react\";\r\nimport Context from \"./context\";\r\nimport { IField } from \"./type\";\r\n\r\nfunction Field(props: IField) {\r\n\tconst { name, required, children } = props;\r\n\tconst state = useReactive({\r\n\t\tvalue: undefined,\r\n\t\tstatus: \"normal\",\r\n\t\tmessage: undefined,\r\n\t\tupdate: 0,\r\n\t});\r\n\tconst form = useContext(Context);\r\n\tconst { id } = form;\r\n\r\n\tconst handleChange = (v) => {\r\n\t\tif (!name) return;\r\n\r\n\t\tform.set(name, v);\r\n\t\tPubSub.publish(`${id}:change`, {\r\n\t\t\tname,\r\n\t\t\tvalue: v,\r\n\t\t});\r\n\t};\r\n\r\n\tconst hijackChildren = useMemo(() => {\r\n\t\treturn Children.map(children, (node) => {\r\n\t\t\tif (!isValidElement(node)) return null;\r\n\r\n\t\t\tconst { onChange } = node.props as any;\r\n\t\t\tconst { value, status, message } = state;\r\n\r\n\t\t\treturn cloneElement(node, {\r\n\t\t\t\tvalue,\r\n\t\t\t\tstatus,\r\n\t\t\t\tmessage,\r\n\t\t\t\trequired,\r\n\t\t\t\tonChange: (...args) => {\r\n\t\t\t\t\thandleChange(args[0]);\r\n\t\t\t\t\tonChange?.(...args);\r\n\t\t\t\t\tObject.assign(state, {\r\n\t\t\t\t\t\tstatus: \"normal\",\r\n\t\t\t\t\t\tmessage: undefined,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t} as any);\r\n\t\t});\r\n\t}, [children, state.update]);\r\n\r\n\tuseEffect(() => {\r\n\t\tif (!name) return;\r\n\r\n\t\tPubSub.subscribe(`${id}:set:${name}`, (evt, v) => {\r\n\t\t\tstate.value = v;\r\n\t\t\tstate.update += 1;\r\n\t\t});\r\n\t\tPubSub.subscribe(`${id}:invalid:${name}`, (evt, v) => {\r\n\t\t\tObject.assign(state, v);\r\n\t\t\tstate.update += 1;\r\n\t\t});\r\n\r\n\t\tPromise.resolve().then(() => {\r\n\t\t\tform.set(name, form.cacheData[name] ?? undefined);\r\n\t\t});\r\n\r\n\t\treturn () => {\r\n\t\t\tPubSub.unsubscribe(`${id}:set:${name}`);\r\n\t\t\tPubSub.unsubscribe(`${id}:invalid:${name}`);\r\n\t\t\tform.delete(name);\r\n\t\t};\r\n\t}, [name, children]);\r\n\r\n\tif (!name) return children;\r\n\r\n\treturn hijackChildren;\r\n}\r\n\r\nexport default Field;\r\n"],"names":[],"mappings":"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"}
{"version":3,"file":"upload.js","sources":["../../../../packages/components/upload/upload.tsx"],"sourcesContent":["import { DriveFolderUploadOutlined, PlusSharp } from \"@ricons/material\";\r\nimport { useReactive } from \"ahooks\";\r\nimport classNames from \"classnames\";\r\nimport { uid } from \"radash\";\r\nimport {\r\n\tChangeEvent,\r\n\tCSSProperties,\r\n\tuseEffect,\r\n\tuseImperativeHandle,\r\n\tuseMemo,\r\n\tuseRef,\r\n} from \"react\";\r\nimport { SortableItem } from \"react-easy-sort\";\r\nimport usePreview from \"../../js/usePreview\";\r\nimport { TPreviewItem } from \"../../js/usePreview/type\";\r\nimport { arrayMove } from \"../../js/utils\";\r\nimport Button from \"../button\";\r\nimport Icon from \"../icon\";\r\nimport InputContainer from \"../input/container\";\r\nimport \"./index.css\";\r\nimport FileListItem, { ListContainer } from \"./renderFile\";\r\nimport { IFile, IUpload } from \"./type\";\r\n\r\nconst Upload = (props: IUpload) => {\r\n\tconst {\r\n\t\tref,\r\n\t\tlabel,\r\n\t\tlabelInline,\r\n\t\tvalue,\r\n\t\tfiles = [],\r\n\t\tinitialFiles,\r\n\t\tplaceholder,\r\n\t\tstatus = \"normal\",\r\n\t\tmessage,\r\n\t\tclassName,\r\n\t\tstyle,\r\n\t\tchildren,\r\n\t\tdefaultButtonProps,\r\n\t\tmode = \"default\",\r\n\t\tcardSize = \"4em\",\r\n\t\tdisabled,\r\n\t\tsortable,\r\n\t\tlimit = props.multiple ? Infinity : 1,\r\n\t\tmultiple,\r\n\t\trenderItem,\r\n\t\tshouldUpload = () => true,\r\n\t\tuploader,\r\n\t\tonChange,\r\n\t\tonFilesChange,\r\n\t\tonUpload,\r\n\t\t...restProps\r\n\t} = props;\r\n\r\n\tconst state = useReactive({\r\n\t\tfiles,\r\n\t\tvalue,\r\n\t\tstatus,\r\n\t\tmessage,\r\n\t});\r\n\tconst inputRef = useRef<HTMLInputElement>(null);\r\n\tconst preview = usePreview();\r\n\tconst defBtnProps = Object.assign(\r\n\t\t{\r\n\t\t\tchildren: (\r\n\t\t\t\t<>\r\n\t\t\t\t\t<Icon icon={<DriveFolderUploadOutlined />} /> 上传\r\n\t\t\t\t</>\r\n\t\t\t),\r\n\t\t},\r\n\t\tdefaultButtonProps\r\n\t);\r\n\r\n\tconst trigger = useMemo(() => {\r\n\t\tif (children) return children;\r\n\r\n\t\tswitch (mode) {\r\n\t\t\tcase \"card\":\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<Button\r\n\t\t\t\t\t\tclassName='i-upload-card-btn color-5'\r\n\t\t\t\t\t\tsquare\r\n\t\t\t\t\t\tflat\r\n\t\t\t\t\t\toutline\r\n\t\t\t\t\t\tdisabled={disabled}\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t<Icon icon={<PlusSharp />} />\r\n\t\t\t\t\t</Button>\r\n\t\t\t\t);\r\n\t\t\tdefault:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<Button\r\n\t\t\t\t\t\t{...defBtnProps}\r\n\t\t\t\t\t\tclassName={classNames(\r\n\t\t\t\t\t\t\t\"i-upload-btn\",\r\n\t\t\t\t\t\t\tdefBtnProps.className\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t\tdisabled={disabled}\r\n\t\t\t\t\t/>\r\n\t\t\t\t);\r\n\t\t}\r\n\t}, [mode, children]);\r\n\r\n\tconst handleChange = (e: ChangeEvent<HTMLInputElement>) => {\r\n\t\tconst files = Array.from(e.target.files || []) as IFile[];\r\n\t\tconst { files: before } = state;\r\n\t\tconst changed: IFile[] = [];\r\n\r\n\t\tfiles.map((f) => {\r\n\t\t\tconst { id, name, size, type } = f;\r\n\t\t\tconst same = before.find((pf) => {\r\n\t\t\t\tconst { name: n, size: s, type: t } = pf;\r\n\t\t\t\treturn n === name && s === size && t === type;\r\n\t\t\t});\r\n\t\t\tconst src = URL.createObjectURL(f);\r\n\r\n\t\t\tObject.assign(f, {\r\n\t\t\t\tid: id ?? uid(7),\r\n\t\t\t\tsrc: src ?? f.name,\r\n\t\t\t\turl: src ?? f.name,\r\n\t\t\t});\r\n\t\t\t!same && changed.push(f);\r\n\t\t});\r\n\r\n\t\tconst after = [...before, ...changed];\r\n\r\n\t\tObject.assign(state, {\r\n\t\t\tfiles: multiple ? after.slice(0, limit) : [after.at(-1)],\r\n\t\t\tstatus,\r\n\t\t\tmessage,\r\n\t\t});\r\n\r\n\t\tonFilesChange?.(state.files, changed, e);\r\n\t\tonChange?.(state.files, e);\r\n\r\n\t\thandleUpload(changed);\r\n\t\tinputRef.current && (inputRef.current.value = \"\");\r\n\t};\r\n\r\n\tconst handleRemove = (i: number) => {\r\n\t\tconst [...files] = state.files;\r\n\r\n\t\tconst changed = files.splice(i, 1);\r\n\t\tURL.revokeObjectURL(changed[0]?.src || \"\");\r\n\r\n\t\tstate.files = files;\r\n\t\tonFilesChange?.(files, changed);\r\n\t\tonChange?.(files);\r\n\r\n\t\tinputRef.current && (inputRef.current.value = \"\");\r\n\t};\r\n\r\n\tconst handleUpload = async (files: IFile[]) => {\r\n\t\tif (!uploader) return;\r\n\r\n\t\tconst shouldUploadFiles = files.filter(shouldUpload);\r\n\r\n\t\tconst result = Promise.all(shouldUploadFiles.map(uploader));\r\n\r\n\t\treturn onUpload?.(result);\r\n\t};\r\n\r\n\tconst handlePreview = (i: number) => {\r\n\t\tpreview({ items: state.files as TPreviewItem[], initial: i });\r\n\t};\r\n\r\n\tconst setFileList = (files?: IFile[] | File[]) => {\r\n\t\tif (!files) return;\r\n\r\n\t\tstate.files = files.map((f) => {\r\n\t\t\treturn { ...f, id: f.id ?? uid(7) };\r\n\t\t});\r\n\t};\r\n\r\n\tconst handleSortEnd = (before, after) => {\r\n\t\tconst [...files] = state.files;\r\n\r\n\t\tstate.files = arrayMove(files, before, after);\r\n\t\tonChange?.(state.files);\r\n\t};\r\n\r\n\tuseEffect(() => {\r\n\t\tObject.assign(state, {\r\n\t\t\tstatus,\r\n\t\t\tmessage,\r\n\t\t});\r\n\t}, [status, message]);\r\n\r\n\tuseEffect(() => {\r\n\t\tstate.files = value?.filter?.((file) => !!file.id) ?? [];\r\n\t}, [value]);\r\n\r\n\tuseEffect(() => {\r\n\t\tsetFileList(initialFiles);\r\n\t}, []);\r\n\r\n\tuseImperativeHandle(\r\n\t\tref,\r\n\t\t() => ({\r\n\t\t\tgetFileList: () => state.files,\r\n\r\n\t\t\tsetFileList,\r\n\t\t}),\r\n\t\t[]\r\n\t);\r\n\r\n\treturn (\r\n\t\t<InputContainer\r\n\t\t\tas='div'\r\n\t\t\tlabel={label}\r\n\t\t\tlabelInline={labelInline}\r\n\t\t\tclassName={classNames(\"i-input-label-file\", className)}\r\n\t\t\tstyle={style}\r\n\t\t>\r\n\t\t\t<div\r\n\t\t\t\tclassName={classNames(\"i-upload-inner\", {\r\n\t\t\t\t\t[`i-upload-${mode}`]: mode !== \"default\",\r\n\t\t\t\t})}\r\n\t\t\t\tstyle={{ [\"--upload-card-size\"]: cardSize } as CSSProperties}\r\n\t\t\t>\r\n\t\t\t\t<ListContainer sortable={sortable} onSortEnd={handleSortEnd}>\r\n\t\t\t\t\t{state.files.map((file: IFile, i: number) => {\r\n\t\t\t\t\t\tconst node = (\r\n\t\t\t\t\t\t\t<FileListItem\r\n\t\t\t\t\t\t\t\tkey={i}\r\n\t\t\t\t\t\t\t\tindex={i}\r\n\t\t\t\t\t\t\t\tfile={file}\r\n\t\t\t\t\t\t\t\tmode={mode}\r\n\t\t\t\t\t\t\t\trenderItem={renderItem}\r\n\t\t\t\t\t\t\t\tonRemove={handleRemove}\r\n\t\t\t\t\t\t\t\tonPreview={handlePreview}\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\tif (!sortable) return node;\r\n\r\n\t\t\t\t\t\treturn <SortableItem key={i}>{node}</SortableItem>;\r\n\t\t\t\t\t})}\r\n\t\t\t\t</ListContainer>\r\n\r\n\t\t\t\t{state.message && (\r\n\t\t\t\t\t<span className='i-upload-message'>{state.message}</span>\r\n\t\t\t\t)}\r\n\r\n\t\t\t\t{state.files.length < limit && (\r\n\t\t\t\t\t<label>\r\n\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t{...restProps}\r\n\t\t\t\t\t\t\tdisabled={disabled}\r\n\t\t\t\t\t\t\tref={inputRef}\r\n\t\t\t\t\t\t\ttype='file'\r\n\t\t\t\t\t\t\tclassName='i-input-file-hidden'\r\n\t\t\t\t\t\t\tmultiple={multiple}\r\n\t\t\t\t\t\t\tonChange={handleChange}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t{trigger}\r\n\t\t\t\t\t</label>\r\n\t\t\t\t)}\r\n\t\t\t</div>\r\n\t\t</InputContainer>\r\n\t);\r\n};\r\n\r\nexport default Upload;\r\n"],"names":["_jsxs","_Fragment","_jsx"],"mappings":"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"}
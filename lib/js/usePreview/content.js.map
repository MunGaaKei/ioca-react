{"version":3,"file":"content.js","sources":["../../../packages/js/usePreview/content.tsx"],"sourcesContent":["import Button from \"@p/components/button\";\nimport Icon from \"@p/components/icon\";\nimport {\n\tAspectRatioRound,\n\tCloseRound,\n\tFileDownloadOutlined,\n\tKeyboardArrowLeftRound,\n\tKeyboardArrowRightRound,\n\tOpenInNewRound,\n\tRotateLeftRound,\n\tRotateRightRound,\n} from \"@ricons/material\";\nimport { useReactive } from \"ahooks\";\nimport classNames from \"classnames\";\nimport { throttle } from \"radash\";\nimport { useMemo, useRef } from \"react\";\nimport { useMouseMove, useMouseUp } from \"../hooks\";\nimport { getFileType, getSuffixByUrl } from \"../utils\";\nimport DefaultRenderFile from \"./renderFile\";\nimport { IPreview, TFileType, TPreviewItem } from \"./type\";\n\nexport default function Content(props: IPreview) {\n\tconst {\n\t\titems = [],\n\t\tinitial = 0,\n\t\trenderFile = DefaultRenderFile,\n\t\tonRotate,\n\t\tonChange,\n\t\tonClose,\n\t\tonZoom,\n\t} = props;\n\tconst state = useReactive({\n\t\tcurrent: initial,\n\t\trotate: 0,\n\t\tscale: 1,\n\t\ttranslate: [0, 0],\n\t\tstart: [0, 0],\n\t\tdragging: false,\n\t\tcontrolHidden: true,\n\t});\n\tconst box = useRef<HTMLDivElement>(null);\n\tconst translate = useRef<number[]>([0, 0]);\n\tconst hiddenTO = useRef<any>(null);\n\n\tconst files = useMemo(() => {\n\t\treturn items.map((item) => {\n\t\t\tconst o: TPreviewItem = {\n\t\t\t\tsrc: \"\",\n\t\t\t};\n\t\t\tif (typeof item === \"string\") {\n\t\t\t\to.src = item;\n\t\t\t} else {\n\t\t\t\tObject.assign(o, item);\n\t\t\t}\n\n\t\t\to.suffix = getSuffixByUrl(o.src) || \"\";\n\t\t\to.type = getFileType(o.suffix, item[\"type\"]);\n\n\t\t\treturn o;\n\t\t});\n\t}, [items]);\n\n\tconst { file, content } = useMemo(() => {\n\t\tconst file = files[state.current];\n\t\tconst content = renderFile(file);\n\n\t\treturn {\n\t\t\tfile,\n\t\t\tcontent,\n\t\t};\n\t}, [state.current, items]);\n\n\tconst isImage = file.type === TFileType.IMAGE;\n\n\tconst handleSwitch = (next: number) => {\n\t\tconst l = files.length;\n\t\tconst { current: before } = state;\n\t\tif (next >= l) {\n\t\t\tstate.current = 0;\n\t\t} else if (next < 0) {\n\t\t\tstate.current = l - 1;\n\t\t} else {\n\t\t\tstate.current = next;\n\t\t}\n\t\tonChange?.(state.current, before);\n\n\t\tstate.rotate = files[state.current].rotate || 0;\n\n\t\tif (state.scale !== 1) {\n\t\t\tstate.scale = 1;\n\t\t\tonZoom?.(1);\n\t\t}\n\t\tonRotate?.(state.rotate);\n\t\tstate.translate = translate.current = [0, 0];\n\t};\n\n\tconst handleRotate = (deg: number) => {\n\t\tstate.rotate += deg;\n\n\t\tonRotate?.(state.rotate);\n\t};\n\n\tconst handleMouseWheel = throttle({ interval: 60 }, (e) => {\n\t\tif (!isImage) return;\n\t\tlet after = state.scale + (e.deltaY < 0 ? 0.05 : -0.05);\n\t\tif (after > 2) after = 2;\n\t\tif (after < 0.25) after = 0.25;\n\n\t\tonZoom?.(after);\n\t\tstate.scale = after;\n\t});\n\n\tconst handleMouseDown = (e) => {\n\t\tif (!isImage) return;\n\t\te.preventDefault();\n\t\tstate.dragging = true;\n\t\tstate.start = [e.pageX, e.pageY];\n\t};\n\n\tconst clearHiddenTO = () => {\n\t\tif (!hiddenTO.current || state.controlHidden) return;\n\t\tclearTimeout(hiddenTO.current);\n\t\thiddenTO.current = null;\n\t};\n\n\tconst setHiddenFalse = () => {\n\t\tif (!state.controlHidden) return;\n\t\tstate.controlHidden = false;\n\n\t\tclearHiddenTO();\n\t\thiddenTO.current = setTimeout(() => {\n\t\t\tstate.controlHidden = true;\n\t\t}, 1000);\n\t};\n\n\tconst throttleMouseMove = throttle({ interval: 300 }, setHiddenFalse);\n\n\tconst handleMouseMove = (e) => {\n\t\tthrottleMouseMove();\n\t\tif (!state.dragging) return;\n\t\te.preventDefault();\n\n\t\tconst [x, y] = translate.current;\n\t\tconst [ox, oy] = state.start;\n\t\tconst offsetX = e.pageX - ox;\n\t\tconst offsetY = e.pageY - oy;\n\n\t\tstate.translate = [x + offsetX, y + offsetY];\n\t};\n\n\tconst handleMouseUp = () => {\n\t\tif (!state.dragging) return;\n\t\tstate.dragging = false;\n\t\ttranslate.current = state.translate;\n\t};\n\n\tuseMouseMove(handleMouseMove);\n\tuseMouseUp(handleMouseUp);\n\n\treturn (\n\t\t<>\n\t\t\t<div\n\t\t\t\tref={box}\n\t\t\t\tclassName={classNames(\"i-preview-content\", {\n\t\t\t\t\t\"no-transition\": state.dragging,\n\t\t\t\t})}\n\t\t\t\tstyle={{\n\t\t\t\t\ttransform: `translate(${state.translate\n\t\t\t\t\t\t.map((n) => `${n}px`)\n\t\t\t\t\t\t.join(\",\")}) rotate(${state.rotate}deg) scale(${\n\t\t\t\t\t\tstate.scale\n\t\t\t\t\t})`,\n\t\t\t\t}}\n\t\t\t\tonWheel={handleMouseWheel}\n\t\t\t\tonMouseDown={handleMouseDown}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{content}\n\t\t\t</div>\n\n\t\t\t<div\n\t\t\t\tclassName={classNames(\"i-preview-controls\", {\n\t\t\t\t\t\"i-preview-controls-hidden\": state.controlHidden,\n\t\t\t\t})}\n\t\t\t>\n\t\t\t\t<Button square flat onClick={onClose}>\n\t\t\t\t\t<Icon icon={<CloseRound />} />\n\t\t\t\t</Button>\n\t\t\t\t{files.length > 1 && (\n\t\t\t\t\t<span className='px-8'>\n\t\t\t\t\t\t{state.current + 1} / {files.length}\n\t\t\t\t\t</span>\n\t\t\t\t)}\n\t\t\t\t{state.scale !== 1 && (\n\t\t\t\t\t<Button flat onClick={() => (state.scale = 1)}>\n\t\t\t\t\t\t<Icon icon={<AspectRatioRound />} />\n\t\t\t\t\t\t<span className='mt-2'>\n\t\t\t\t\t\t\t{(state.scale * 100).toFixed(0)}%\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</Button>\n\t\t\t\t)}\n\t\t\t\t<Button square flat href={file.src} target='_blank'>\n\t\t\t\t\t<Icon icon={<OpenInNewRound />} />\n\t\t\t\t</Button>\n\t\t\t\t<Button square flat href={file.src} download target='_blank'>\n\t\t\t\t\t<Icon icon={<FileDownloadOutlined />} />\n\t\t\t\t</Button>\n\t\t\t\t<Button square flat onClick={() => handleRotate(90)}>\n\t\t\t\t\t<Icon icon={<RotateRightRound />} />\n\t\t\t\t</Button>\n\t\t\t\t<Button square flat onClick={() => handleRotate(-90)}>\n\t\t\t\t\t<Icon icon={<RotateLeftRound />} />\n\t\t\t\t</Button>\n\n\t\t\t\t{files.length > 1 && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tsquare\n\t\t\t\t\t\t\tflat\n\t\t\t\t\t\t\tonClick={() => handleSwitch(state.current - 1)}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Icon icon={<KeyboardArrowLeftRound />} />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tsquare\n\t\t\t\t\t\t\tflat\n\t\t\t\t\t\t\tonClick={() => handleSwitch(state.current + 1)}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Icon icon={<KeyboardArrowRightRound />} />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t</>\n\t);\n}\n"],"names":["Content","props","items","initial","renderFile","DefaultRenderFile","onRotate","onChange","onClose","onZoom","state","useReactive","current","rotate","scale","translate","start","dragging","controlHidden","box","useRef","hiddenTO","files","useMemo","map","item","o","src","Object","assign","suffix","getSuffixByUrl","type","getFileType","file","content","isImage","TFileType","IMAGE","handleSwitch","next","l","length","before","handleRotate","deg","handleMouseWheel","throttle","interval","e","after","deltaY","throttleMouseMove","clearTimeout","setTimeout","useMouseMove","preventDefault","x","y","ox","oy","offsetX","pageX","offsetY","pageY","useMouseUp","_jsxs","_Fragment","children","_jsx","ref","className","classNames","style","transform","n","join","onWheel","onMouseDown","onClick","stopPropagation","Button","square","flat","Icon","icon","CloseRound","AspectRatioRound","toFixed","href","target","OpenInNewRound","download","FileDownloadOutlined","RotateRightRound","RotateLeftRound","KeyboardArrowLeftRound","KeyboardArrowRightRound"],"mappings":"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"}